<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RSilent Studio | Pre-Alpha v0.1</title>
<meta name="description" content="Roomla — short web horror prototype (pre-alpha) by Silent Studio" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
<style>
  /* ===========================
     Roomla — Pre-Alpha single file
     =========================== */
  :root{
    --bg:#030305;
    --muted:#98a3b3;
    --accent:#9bf;
    --danger:#ff5a5a;
    --calm:#66f0a8;
    --glass: rgba(255,255,255,0.03);
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:#000;color:#e8eef6;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; -webkit-font-smoothing:antialiased}
  .center{max-width:1200px;margin:18px auto;padding:12px}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .title{font-family:Orbitron,monospace;font-weight:700;letter-spacing:2px}
  .subtitle{color:var(--muted);font-size:13px}
  /* scene */
  .scene{margin-top:12px;display:grid;grid-template-columns:1fr 320px;gap:16px}
  .room-card{position:relative;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);box-shadow:0 18px 60px rgba(0,0,0,0.7);background:#050406}
  .room-visual{height:640px;background-size:cover;background-position:center center;position:relative}
  /* background image will be set inline via style attr */
  /* interactive layer */
  .room-layer{position:absolute;inset:0;pointer-events:auto}
  /* pc hotspot approximate area top-right quadrant lower part */
  .pc-hotspot{position:absolute; width:220px; height:140px; right:12%; top:14%; transform:translateY(10%); cursor:pointer; border-radius:8px;}
  .pc-visual{position:absolute; right:12%; top:14%; width:240px;height:160px; transform-origin:center center; display:flex;align-items:center;justify-content:center;pointer-events:none}
  .pc-visual img{width:100%;height:100%;object-fit:cover;border-radius:8px;filter:contrast(.9) saturate(.85) hue-rotate(2deg)}
  /* pill icon centered bottom */
  .pill-visual{position:absolute; left:50%; transform:translateX(-50%); bottom:6%; width:160px;height:72px; display:flex; align-items:center; justify-content:center; gap:12px; pointer-events:none}
  .pill-slot{width:48px;height:48px;border-radius:8px;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.03)}
  .pill-slot img{width:42px;height:42px;object-fit:contain}
  .pill-clickable{pointer-events:auto; cursor:pointer}
  /* right panel */
  .panel{padding:12px;display:flex;flex-direction:column;gap:12px}
  .box{background:linear-gradient(180deg,rgba(255,255,255,0.015), rgba(255,255,255,0.006)); border-radius:8px;padding:12px;border:1px solid rgba(255,255,255,0.02)}
  .metrics{display:flex;flex-direction:column;gap:8px}
  .metric{display:flex;justify-content:space-between;align-items:center;font-size:13px;color:var(--muted)}
  .metric .val{font-weight:700;color:#fff}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;color:var(--accent);cursor:pointer}
  .btn.ghost{opacity:.8}
  .kbd{background:#071018;padding:6px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.02);font-family:var(--mono);font-size:12px}
  /* overlay (zoom/PC view) */
  .zoom-wrap{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1200;background:rgba(0,0,0,0.6)}
  .pc-view{width:min(920px,92%);height:min(560px,78%);background:#05070a;border-radius:10px;border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;overflow:hidden}
  .pc-top{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,0.02)}
  .pc-screen{flex:1;display:flex;align-items:center;justify-content:center;padding:18px;font-family:var(--mono);color:#9ff; font-size:15px; text-align:center}
  .pc-bottom{padding:10px;display:flex;gap:8px;align-items:center;justify-content:flex-end}
  .cooldown-bar{height:8px;background:rgba(255,255,255,0.04);border-radius:6px;overflow:hidden}
  .cooldown-fill{height:100%;width:0%;background:linear-gradient(90deg,#57f 0%,#9bf 100%);transition:width .25s linear}
  /* overlay tasks */
  .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center; z-index:1400;background:rgba(0,0,0,0.72)}
  .taskbox{width:min(840px,96%);background:#060708;border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.03)}
  .task-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px}
  .task-card{background:#081018;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);cursor:pointer;text-align:center;color:#cfe}
  .task-card:hover{transform:translateY(-4px);transition:transform .12s}
  /* panic overlay red flash */
  .panic-overlay{position:fixed;inset:0;pointer-events:none;z-index:1600;background:rgba(0,0,0,0);transition:background .12s linear}
  /* jumpscare overlay */
  .jumpscare{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:2200;background:#000}
  .jumpscare video, .jumpscare img{max-width:100%;max-height:100%;display:block}
  /* small tips */
  .tip{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:rgba(0,0,0,0.6);padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);color:var(--muted);font-size:13px;z-index:2000}
  /* responsive */
  @media (max-width:980px){
    .scene{grid-template-columns:1fr}
    .room-visual{height:56vh}
    .pc-visual{display:none}
  }
</style>
</head>
<body>
<div class="center">
  <div class="topbar">
    <div>
      <div class="title">ROOMLA • Silent Studio</div>
      <div class="subtitle">Pre-alpha v1.0 — short prototype</div>
    </div>
    <div class="subtitle">Goal: complete <strong>10</strong> childlike tasks</div>
  </div>

  <!-- START: device choice modal -->
  <div id="startModal" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:3000;background:rgba(0,0,0,0.85)">
    <div style="background:#060708;padding:22px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);width:92%;max-width:720px;text-align:center">
      <h2 style="margin:0 0 8px;font-family:Orbitron,monospace">Pre-alpha</h2>
      <p style="color:var(--muted);margin:0 0 14px">Select the device you play on. This unlocks audio and input. Mobile mode disables Escape and uses touch controls.</p>
      <div style="display:flex;gap:12px;justify-content:center;margin-top:12px">
        <button class="btn" id="choosePC">Play on PC</button>
        <button class="btn" id="chooseMobile">Play on Mobile</button>
      </div>
      <div style="color:var(--muted);font-size:13px;margin-top:12px">Clicking either starts audio and enables the prototype.</div>
    </div>
  </div>

  <div class="scene">
    <!-- LEFT: room visual -->
    <div class="room-card">
      <div id="roomVisual" class="room-visual" style="background-image:url('https://i.imgur.com/O9vg7SA.jpeg');">
        <div class="room-layer" id="roomLayer">
          <!-- PC hotspot (in right-top quadrant lower part) -->
          <div class="pc-hotspot" id="pcHotspot" title="PC — click to zoom"></div>
          <!-- Visual PC (for zoom preview) -->
          <div class="pc-visual" id="pcVisual">
            <!-- we'll draw a small monitor-like overlay -->
            <img id="pcThumb" src="" alt="pc-thumb">
          </div>

          <!-- Pills visual centered bottom -->
          <div class="pill-visual" id="pillsVisual" style="pointer-events:auto">
            <!-- five clickable pill slots; we'll fill with your pill icon -->
            <div class="pill-slot pill-clickable" data-idx="0"><img src="https://i.imgur.com/vz9eh1m.jpeg" alt="pill"></div>
            <div class="pill-slot pill-clickable" data-idx="1"><img src="https://i.imgur.com/vz9eh1m.jpeg" alt="pill"></div>
            <div class="pill-slot pill-clickable" data-idx="2"><img src="https://i.imgur.com/vz9eh1m.jpeg" alt="pill"></div>
            <div class="pill-slot pill-clickable" data-idx="3"><img src="https://i.imgur.com/vz9eh1m.jpeg" alt="pill"></div>
            <div class="pill-slot pill-clickable" data-idx="4"><img src="https://i.imgur.com/vz9eh1m.jpeg" alt="pill"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: info -->
    <div class="room-card panel">
      <div class="box">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">GAME</div>
          <div style="color:var(--muted);font-size:13px">Prototype</div>
        </div>
        <div style="margin-top:8px;color:var(--muted);font-size:13px">Complete 10 childlike tasks while managing panic and pills. If panic reaches critical level, breathing events and eventually a jumpscare will occur.</div>
      </div>

      <div class="box metrics">
        <div class="metric"><div>Pills:</div><div class="val" id="uiPills">5</div></div>
        <div class="metric"><div>Panic:</div><div class="val" id="uiPanic">0%</div></div>
        <div class="metric"><div>Active Task:</div><div class="val" id="uiActive">None</div></div>
        <div class="metric"><div>Progress:</div><div class="val" id="uiProgress">0 / 10</div></div>
        <div class="metric"><div>Time left:</div><div class="val" id="uiTimer">10:00</div></div>
      </div>

      <div class="box">
        <div style="font-weight:700;margin-bottom:8px">Controls</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <div class="kbd">Open PC: Click PC / Enter</div>
          <div class="kbd">Take pill: P or click</div>
          <div class="kbd">Power off: Power button</div>
          <div class="kbd">Abort task: Esc (PC only)</div>
        </div>
      </div>

      <div class="box" style="margin-top:auto">
        <div style="display:flex;gap:8px">
          <button class="btn ghost" id="btnOpenPC">Open PC</button>
          <button class="btn" id="btnPower">POWER OFF</button>
          <button class="btn" id="btnTakePill">Take Pill (P)</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PC Zoom view -->
<div class="zoom-wrap" id="zoomWrap" aria-hidden="true">
  <div class="pc-view" id="pcView" role="dialog" aria-modal="true">
    <div class="pc-top">
      <div style="font-family:var(--mono);font-weight:700" id="pcTitle">OLD PC — TASKS</div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="cooldown-bar" style="width:160px">
          <div class="cooldown-fill" id="cooldownFill"></div>
        </div>
        <div class="kbd" id="pcPowerState">ON</div>
        <button class="btn ghost" id="pcClose">Back (Esc)</button>
      </div>
    </div>
    <div class="pc-screen" id="pcScreenInner">Click a task to start. Complete 10 total tasks.</div>
    <div class="pc-bottom">
      <div style="color:var(--muted);font-size:13px;margin-right:auto">Tips: <span id="uiTip">Open PC and choose a task.</span></div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="openTasks">Tasks</button>
        <button class="btn ghost" id="pcPower">Power Off</button>
      </div>
    </div>
  </div>
</div>

<!-- Tasks overlay -->
<div class="overlay" id="taskOverlay" aria-hidden="true">
  <div class="taskbox" role="document">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800;font-family:var(--mono)" id="taskHeaderTitle">Tasks</div>
      <div style="display:flex;gap:8px;align-items:center">
        <div style="color:var(--muted);font-size:13px">Task timer: <span id="taskCountdown">--</span></div>
        <button class="btn ghost" id="abortBtn">Abort</button>
      </div>
    </div>

    <div id="taskBody" style="margin-top:12px">
      <div class="task-grid" id="taskGrid">
        <!-- cards filled by JS -->
      </div>
    </div>
  </div>
</div>

<!-- Panic overlay -->
<div class="panic-overlay" id="panicOverlay" aria-hidden="true"></div>

<!-- jumpscare -->
<div class="jumpscare" id="jumpscare" aria-hidden="true">
  <!-- try to play the mov file; if it fails, fallback to text -->
  <video id="jumpscareVideo" src="https://files.catbox.moe/cskqo9.mov" preload="auto" playsinline></video>
</div>

<!-- tip bubble -->
<div class="tip" id="tipBubble">Press Enter or click the PC to open tasks.</div>

<script>
/* =========================
   Roomla v1.0 — single file script
   ========================= */

(function(){
  // ---------- config ----------
  const ROOM_IMG = 'https://i.imgur.com/O9vg7SA.jpeg'; // room background
  const PILL_IMG = 'https://i.imgur.com/vz9eh1m.jpeg'; // pill icon
  const BREATH_MP3 = 'https://files.catbox.moe/crj8v7.mp3'; // breathing audio
  const JUMPSCARE_VIDEO = 'https://files.catbox.moe/cskqo9.mov'; // mov file (may or may not autoplay)
  const MAX_PILLS = 5;
  const TARGET_TASKS = 10;
  const GAME_DURATION_MS = 10 * 60 * 1000; // 10 minutes
  // panic auto drift config
  const PANIC_MIN = 0;
  const PANIC_MAX = 100;

  // ---------- state ----------
  let deviceMode = null; // "pc" or "mobile"
  let audioCtx = null;
  let ambientGain = null;
  let breathAudioBuffer = null;
  let breathSource = null;
  let breathingPlaying = false;
  let panic = 0;
  let pills = MAX_PILLS;
  let progress = 0;
  let activeTask = null;
  let taskTimer = null;
  let taskTimeLeft = 0;
  let pcCooldown = 0; // seconds remaining before PC usable again after power-off
  let pcCooldownInterval = null;
  let gameStartAt = Date.now();
  let gameTimerInterval = null;
  let tipInterval = null;
  let panicAutoInterval = null;
  let breathEventTimeout = null;
  let jumpscareTriggered = false;
  let pcOpen = false;

  // ---------- DOM ----------
  const startModal = document.getElementById('startModal');
  const choosePC = document.getElementById('choosePC');
  const chooseMobile = document.getElementById('chooseMobile');

  const roomVisual = document.getElementById('roomVisual');
  const pcHotspot = document.getElementById('pcHotspot');
  const pcVisual = document.getElementById('pcVisual');
  const pcThumb = document.getElementById('pcThumb');
  const pillsVisual = document.getElementById('pillsVisual');
  const pillSlots = Array.from(document.querySelectorAll('.pill-slot'));

  const uiPills = document.getElementById('uiPills');
  const uiPanic = document.getElementById('uiPanic');
  const uiActive = document.getElementById('uiActive');
  const uiProgress = document.getElementById('uiProgress');
  const uiTimer = document.getElementById('uiTimer');

  const btnOpenPC = document.getElementById('btnOpenPC');
  const btnPower = document.getElementById('btnPower');
  const btnTakePill = document.getElementById('btnTakePill');

  const zoomWrap = document.getElementById('zoomWrap');
  const pcView = document.getElementById('pcView');
  const pcClose = document.getElementById('pcClose');
  const pcPower = document.getElementById('pcPower');
  const pcPowerState = document.getElementById('pcPowerState');
  const pcScreenInner = document.getElementById('pcScreenInner');
  const openTasksBtn = document.getElementById('openTasks');
  const uiTip = document.getElementById('uiTip');
  const cooldownFill = document.getElementById('cooldownFill');

  const taskOverlay = document.getElementById('taskOverlay');
  const taskGrid = document.getElementById('taskGrid');
  const taskHeaderTitle = document.getElementById('taskHeaderTitle');
  const taskCountdown = document.getElementById('taskCountdown');
  const abortBtn = document.getElementById('abortBtn');

  const panicOverlay = document.getElementById('panicOverlay');
  const jumpscare = document.getElementById('jumpscare');
  const jumpscareVideo = document.getElementById('jumpscareVideo');

  const tipBubble = document.getElementById('tipBubble');

  // preload visuals
  pcThumb.src = ROOM_IMG; // just a slice for effect (will scale during zoom)

  // ---------- audio helpers ----------
  function ensureAudio(){
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    ambientGain = audioCtx.createGain(); ambientGain.gain.value = 0.02; ambientGain.connect(audioCtx.destination);
  }

  async function loadBreath(){
    try {
      ensureAudio();
      const resp = await fetch(BREATH_MP3);
      const ab = await resp.arrayBuffer();
      breathAudioBuffer = await audioCtx.decodeAudioData(ab);
    } catch(e){
      console.warn('Breath load failed', e);
    }
  }

  // play a one-shot breathing audio (slightly pitched by panic)
  function playBreathOnce(){
    if (!breathAudioBuffer || !audioCtx) return;
    const s = audioCtx.createBufferSource();
    s.buffer = breathAudioBuffer;
    const g = audioCtx.createGain(); g.gain.value = 0.6 * Math.min(1, panic/100 + 0.2);
    s.connect(g); g.connect(audioCtx.destination);
    // pitch variation based on panic
    s.playbackRate.value = 1 + (panic - 50)/400; // small pitch change
    s.start();
    // stop reference
    setTimeout(()=> { try { s.stop(); } catch(e){} }, (s.buffer.duration + 2000));
  }

  // ambient random click / hum — synthesized small noises
  function playAmbientTick(){
    ensureAudio();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain(); g.gain.value = 0.015;
    o.type = Math.random() < 0.6 ? 'sine' : 'triangle';
    o.frequency.value = 60 + Math.random()*240;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.25 + Math.random()*0.4);
    setTimeout(()=>{ try { o.stop(); } catch(e){} }, 350 + Math.random()*400);
  }

  // big loud burst for jumpscare (synth + noise)
  function jumpscareSound(){
    ensureAudio();
    // oscillator
    const o = audioCtx.createOscillator(); o.type = 'sawtooth'; o.frequency.value = 80;
    const og = audioCtx.createGain(); og.gain.value = 0.0005;
    o.connect(og); og.connect(audioCtx.destination);
    o.start();
    og.gain.linearRampToValueAtTime(1.2, audioCtx.currentTime + 0.05);
    // noise
    const bufferSize = audioCtx.sampleRate * 0.25;
    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i=0;i<bufferSize;i++) data[i] = (Math.random()*2 - 1) * Math.exp(-i / bufferSize * 3);
    const noise = audioCtx.createBufferSource(); noise.buffer = buffer;
    const ng = audioCtx.createGain(); ng.gain.value = 0.001;
    noise.connect(ng); ng.connect(audioCtx.destination);
    noise.start();
    ng.gain.linearRampToValueAtTime(0.9, audioCtx.currentTime + 0.06);
    setTimeout(()=>{ ng.gain.linearRampToValueAtTime(0.0001, audioCtx.currentTime + 0.16); noise.stop(audioCtx.currentTime + 0.18); }, 100);
    og.gain.linearRampToValueAtTime(0.0001, audioCtx.currentTime + 0.16);
    setTimeout(()=>{ try { o.stop(); } catch(e){} }, 220);
  }

  // ---------- UI helpers ----------
  function setPanicUI(){
    uiPanic.textContent = `${Math.round(panic)}%`;
    const alpha = Math.min(0.8, panic/150);
    panicOverlay.style.background = `rgba(180,0,0,${alpha})`;
    // small vignette flicker if panic high
    if (panic >= 80) panicOverlay.style.transition = 'background .06s linear';
    else panicOverlay.style.transition = 'background .18s linear';
  }
  function setPillsUI(){
    uiPills.textContent = String(pills);
    pillSlots.forEach((slot, idx)=>{
      if (idx < (MAX_PILLS - pills)) slot.classList.add('empty');
      else slot.classList.remove('empty');
    });
  }
  function setProgressUI(){
    uiProgress.textContent = `${progress} / ${TARGET_TASKS}`;
  }
  function setActiveUI(){
    uiActive.textContent = activeTask ? activeTask : 'None';
  }

  // ---------- Panic auto behavior ----------
  // random small jumps + slow drift; call often
  function startPanicAuto(){
    if (panicAutoInterval) clearInterval(panicAutoInterval);
    panicAutoInterval = setInterval(()=>{
      // small random jump
      const rnd = Math.random();
      if (rnd < 0.15){
        // occasional small jump
        panic = Math.min(PANIC_MAX, panic + (6 + Math.random()*12));
      } else {
        // gentle drift up or down slightly
        panic = Math.max(0, panic + (Math.random() - 0.48) * 1.8);
      }
      setPanicUI();
      // occasionally play ambient tick
      if (Math.random() < 0.12) playAmbientTick();
      // if panic above threshold, schedule breath event
      if (panic >= 80) scheduleBreathEvent();
    }, 900);
  }

  // breath event scheduling (if panic >= 80)
  function scheduleBreathEvent(){
    if (breathEventTimeout) { clearTimeout(breathEventTimeout); breathEventTimeout = null; }
    if (panic < 80) return;
    const min = 700; const max = 2200;
    const next = Math.max(min, Math.floor(max - (panic - 80) * 20) + (Math.random()*400 - 200));
    breathEventTimeout = setTimeout(()=> { playBreathOnce(); /* visual hint */ flashPanicPulse(); /* consequence if active task */ handleBreathDuringTask(); scheduleBreathEvent(); }, next);
  }

  function flashPanicPulse(){
    panicOverlay.style.transition = 'background .08s linear';
    panicOverlay.style.background = 'rgba(200,0,0,0.8)';
    setTimeout(()=> { if (!jumpscareTriggered) panicOverlay.style.background = `rgba(180,0,0,${Math.min(0.6, panic/150)})`; }, 240);
  }

  // if breath happens and player is at PC doing a task, require power off quickly
  function handleBreathDuringTask(){
    if (activeTask && pcOpen){
      // small grace that depends on panic
      const base = 1500; const grace = Math.max(500, base - panic*10);
      let handled = false;
      // set ephemeral handler for power off
      const onPower = function onceHandler(){
        handled = true;
        // abort active task (counts as fail)
        finishTask(false, 'Power cut during breath (abort).');
      };
      pcPower.addEventListener('click', onPower, {once:true});
      setTimeout(()=> {
        if (!handled){
          // failed to power off => penalty
          if (pills > 0) { pills = Math.max(0, pills - 1); setPillsUI(); showScreenText('You dropped a pill in panic (lost 1).'); }
          else { panic = Math.min(PANIC_MAX, panic + 18); setPanicUI(); }
          if (activeTask) finishTask(false, 'You froze — task failed.');
        }
      }, grace + 30);
    }
  }

  // ---------- game timer ----------
  function startGameTimer(){
    gameStartAt = Date.now();
    if (gameTimerInterval) clearInterval(gameTimerInterval);
    gameTimerInterval = setInterval(()=> {
      const rem = Math.max(0, GAME_DURATION_MS - (Date.now() - gameStartAt));
      const mm = Math.floor(rem/60000);
      const ss = Math.floor((rem%60000)/1000).toString().padStart(2,'0');
      uiTimer.textContent = `${mm}:${ss}`;
      if (rem <= 0){
        clearInterval(gameTimerInterval);
        gameOver(false, 'Time ran out.');
      }
    }, 700);
  }

  // ---------- UI tips ----------
  const TIPS = [
    'Press P or click a pill to calm down.',
    'If you hear breathing, power off the PC quickly to abort tasks.',
    'Turning off PC starts a 30s cooldown before reopening.',
    'Complete 10 tasks to reach the ending.',
    'Mobile mode disables Escape; use touch controls.',
  ];
  function startTips(){
    let i = 0;
    uiTip.textContent = TIPS[i];
    if (tipInterval) clearInterval(tipInterval);
    tipInterval = setInterval(()=> {
      i = (i+1) % TIPS.length;
      uiTip.textContent = TIPS[i];
      tipBubble.textContent = TIPS[i];
    }, 4500);
  }

  // ---------- tasks (placeholders) ----------
  // We'll generate a pool of simple tasks; total required is 10
  const TASK_POOL = ['memory','typing','eat','pac','repair','memory','typing','eat','repair','pac'];

  function renderTaskGrid(){
    taskGrid.innerHTML = '';
    TASK_POOL.forEach((t, idx)=>{
      const el = document.createElement('div');
      el.className = 'task-card';
      el.dataset.task = t;
      el.dataset.order = idx;
      el.textContent = `${t.toUpperCase()} — Task ${idx+1}`;
      el.addEventListener('click', ()=> {
        startTaskInstance(t, idx);
      });
      taskGrid.appendChild(el);
    });
  }

  // ---------- task lifecycle ----------
  function startTaskInstance(kind, index){
    if (activeTask) { showScreenText('Finish current task first.'); return; }
    activeTask = `${kind}#${index+1}`;
    setActiveUI();
    openTaskOverlay(kind);
    // set per-task durations
    let dur = 50;
    if (kind === 'typing') dur = 75;
    if (kind === 'memory') dur = 60;
    if (kind === 'eat') dur = 45;
    if (kind === 'pac') dur = 55;
    if (kind === 'repair') dur = 50;
    taskTimeLeft = dur;
    taskCountdown.textContent = `${taskTimeLeft}s`;
    if (taskTimer) clearInterval(taskTimer);
    taskTimer = setInterval(()=> {
      taskTimeLeft--;
      taskCountdown.textContent = `${taskTimeLeft}s`;
      if (taskTimeLeft <= 0){
        clearInterval(taskTimer);
        taskTimer = null;
        finishTask(false, 'Time expired.');
      }
    }, 1000);
  }

  function finishTask(success, reason){
    if (!activeTask) return;
    // close UI
    closeTaskOverlay();
    if (taskTimer) { clearInterval(taskTimer); taskTimer = null; }
    const prev = activeTask;
    activeTask = null;
    setActiveUI();
    if (success){
      progress++;
      setProgressUI();
      panic = Math.max(0, panic - (8 + Math.random()*8));
      setPanicUI();
      showScreenText('Task completed. Progress +' + 1);
      playAmbientTick();
      if (progress >= TARGET_TASKS) {
        gameOver(true, 'You forced a memory to return.');
        return;
      }
    } else {
      panic = Math.min(100, panic + (10 + Math.random()*10));
      setPanicUI();
      showScreenText(reason || 'Task failed.');
    }
  }

  // ---------- open / close overlays ----------
  function openZoomToPC(){
    // if cooldown active, show bar
    if (pcCooldown > 0){
      showScreenText('PC is cooling down. Wait ' + pcCooldown + 's.');
      return;
    }
    zoomWrap.style.display = 'flex';
    zoomWrap.setAttribute('aria-hidden','false');
    pcOpen = true;
    openTaskOverlayUI(); // set tasks inside pc view available via button
    setActiveUI();
  }
  function closeZoomToPC(){
    zoomWrap.style.display = 'none';
    zoomWrap.setAttribute('aria-hidden','true');
    pcOpen = false;
    // when closing PC view, small panic decay
    panic = Math.max(0, panic - 1.5);
    setPanicUI();
  }

  function openTaskOverlay(kind){
    // show tasks overlay (full list of small tasks)
    renderTaskGrid();
    taskOverlay.style.display = 'flex';
    taskOverlay.setAttribute('aria-hidden','false');
    // if starting a specific kind, we replaced content via startTaskInstance
    // otherwise, grid clicking will start tasks
  }
  function closeTaskOverlay(){
    taskOverlay.style.display = 'none';
    taskOverlay.setAttribute('aria-hidden','true');
  }

  // helper: open overlay wrapper when clicking "Tasks" button
  function openTaskOverlayUI(){
    renderTaskGrid();
    taskOverlay.style.display = 'flex';
    taskOverlay.setAttribute('aria-hidden','false');
  }

  // ---------- UI: small in-screen messages ----------
  function showScreenText(txt){
    pcScreenInner.innerHTML = `<div style="color:#9ff">${escapeHtml(txt)}</div>`;
    setTimeout(()=> {
      if (!activeTask) pcScreenInner.innerHTML = 'Click a task to start. Complete 10 total tasks.';
    }, 2400);
  }

  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

  // ---------- power off / cooldown behavior ----------
  function powerOffAction(){
    // toggles power; if turning off during task => abort (fail)
    // but spec: turning off PC should return to main room and reduce panic slowly; when reopening, 30s loading
    if (pcCooldown > 0){
      // if off already in cooldown, turning on not allowed until cooldown 30s finished
      showScreenText('PC still in cooldown.');
      return;
    }
    // start cooldown sequence
    showScreenText('You turned off the PC. Returning to room...');
    // if activeTask -> abort
    if (activeTask) {
      finishTask(false, 'Power off by player.');
    }
    // close pc view if open
    closeZoomToPC();
    // slow panic decay while off (but small)
    let offDecay = setInterval(()=> {
      panic = Math.max(0, panic - 0.6);
      setPanicUI();
    }, 1200);
    // set cooldown 30s during which PC cannot be reopened
    pcCooldown = 30;
    updateCooldownFill();
    if (pcCooldownInterval) clearInterval(pcCooldownInterval);
    pcCooldownInterval = setInterval(()=> {
      pcCooldown--;
      updateCooldownFill();
      if (pcCooldown <= 0){
        clearInterval(pcCooldownInterval);
        pcCooldownInterval = null;
        pcCooldown = 0;
        updateCooldownFill();
        clearInterval(offDecay);
        showScreenText('PC is available again.');
      }
    }, 1000);
  }

  function updateCooldownFill(){
    if (pcCooldown <= 0) {
      cooldownFill.style.width = '0%';
      pcPowerState.textContent = 'ON';
      pcPowerState.style.background = 'transparent';
      return;
    }
    const pct = Math.max(0, Math.min(100, (30 - pcCooldown) / 30 * 100));
    cooldownFill.style.width = pct + '%';
    pcPowerState.textContent = 'COOLDOWN';
    pcPowerState.style.background = 'transparent';
  }

  // ---------- pill behavior ----------
  function takePill(){
    if (pills <= 0) { showScreenText('No pills left.'); playAmbientTick(); return; }
    pills--;
    setPillsUI();
    panic = Math.max(0, panic - 20 - Math.random()*8);
    setPanicUI();
    showScreenText('You took a pill. Breathing calms.');
    playAmbientTick();
    // reset breath schedule
    if (breathEventTimeout) { clearTimeout(breathEventTimeout); breathEventTimeout = null; }
    scheduleBreathEvent();
  }

  // ---------- jumpscare logic ----------
  function triggerJumpscare(){
    if (jumpscareTriggered) return;
    jumpscareTriggered = true;
    // show jumpscare overlay
    jumpscare.style.display = 'flex';
    jumpscare.setAttribute('aria-hidden','false');
    // attempt to play MOV video
    try {
      jumpscareVideo.src = JUMPSCARE_VIDEO;
      jumpscareVideo.currentTime = 0;
      jumpscareVideo.play().catch(()=> {
        // if video fails to play (format), fallback to text + flash
        fallbackJumpscare();
      });
    } catch(e){
      fallbackJumpscare();
    }
    // loud sound
    jumpscareSound();
    // after short delay, end
    setTimeout(()=> {
      gameOver(false, 'Caught by the child.');
    }, 2400);
  }

  function fallbackJumpscare(){
    jumpscare.innerHTML = '<div style="color:#ffb3b3;font-size:28px;font-family:var(--mono);font-weight:800">REMEMBER.</div>';
    jumpscare.style.background = '#120002';
  }

  // ---------- game over ----------
  function gameOver(win, reason){
    // stop everything
    clearInterval(panicAutoInterval); panicAutoInterval = null;
    clearInterval(gameTimerInterval); gameTimerInterval = null;
    clearInterval(pcCooldownInterval); pcCooldownInterval = null;
    if (!win) {
      // if not already jumpscare, trigger
      if (!jumpscareTriggered) triggerJumpscare();
      setTimeout(()=> {
        alert('You failed — ' + (reason || 'Captured.'));
        location.reload();
      }, 2600);
    } else {
      alert('You survived. Memory returns... ' + (reason || 'Victory.'));
      location.reload();
    }
  }

  // ---------- keyboard / input ----------
  document.addEventListener('keydown', (e)=>{
    if (!deviceMode) return;
    if (e.key === 'Enter'){
      if (!pcOpen) openZoomToPC();
      else {
        // if overlay, nothing
      }
    }
    if (e.key.toLowerCase() === 'p') {
      takePill();
    }
    if (e.key === 'Escape'){
      // only PC mode supports escape to exit PC
      if (deviceMode === 'pc' && pcOpen){
        closeZoomToPC();
      } else if (deviceMode === 'pc' && taskOverlay.style.display === 'flex'){
        if (activeTask){
          if (confirm('Abort task? This counts as failure.')) finishTask(false, 'Aborted by player.');
        } else closeTaskOverlay();
      }
    }
  });

  // ---------- event binding ----------
  choosePC.addEventListener('click', async ()=> {
    deviceMode = 'pc';
    startModal.style.display = 'none';
    await initAfterChoose();
  });
  chooseMobile.addEventListener('click', async ()=> {
    deviceMode = 'mobile';
    startModal.style.display = 'none';
    await initAfterChoose();
  });

  pcHotspot.addEventListener('click', ()=> {
    // click hotspot -> open zoom
    openZoomToPC();
  });

  btnOpenPC.addEventListener('click', ()=> openZoomToPC());
  btnPower.addEventListener('click', ()=> {
    powerOffAction();
  });
  btnTakePill.addEventListener('click', ()=> takePill());

  // pill visuals clickable
  pillSlots.forEach(slot => {
    slot.addEventListener('click', ()=> {
      if (slot.classList.contains('empty')) { showScreenText('No pill here.'); return; }
      takePill();
    });
  });

  pcClose.addEventListener('click', ()=> {
    if (deviceMode === 'mobile') { showScreenText('Use the back button on mobile.'); return; }
    closeZoomToPC();
  });

  pcPower.addEventListener('click', ()=> {
    powerOffAction();
  });

  openTasksBtn.addEventListener('click', ()=> openTaskOverlayUI());
  abortBtn.addEventListener('click', ()=> {
    if (activeTask) {
      if (confirm('Abort task? This counts as failure.')) finishTask(false, 'Aborted by player.');
    } else closeTaskOverlay();
  });

  taskOverlay.addEventListener('click', (e)=> {
    if (e.target === taskOverlay && !activeTask) closeTaskOverlay();
  });

  // close jumpscare on click (for safety)
  jumpscare.addEventListener('click', ()=> {
    // stop video if playing
    try { jumpscareVideo.pause(); } catch(e){}
    jumpscare.style.display = 'none';
  });

  // ---------- initialization after device chosen ----------
  async function initAfterChoose(){
    // start audio after first user gesture
    ensureAudio();
    await loadBreath();
    // small ambient scheduler
    startPanicAuto();
    startTips();
    startGameTimer();
    // schedule ambient ticks randomly
    setInterval(()=> { if (Math.random() < 0.18) playAmbientTick(); }, 1200);
    // initial UI
    setPanicUI(); setPillsUI(); setProgressUI(); setActiveUI();
    renderTaskGrid();
    showScreenText('You wake up. The room is quiet. Click the PC or press Enter to open tasks.');
    // small random panic rises to kick things off
    setTimeout(()=> { panic = 6 + Math.random()*8; setPanicUI(); scheduleBreathEvent(); }, 1200);
    // tip bubble fade
    setTimeout(()=> { tipBubble.style.opacity = 0.85; }, 100);
  }

})(); // IIFE end
</script>
</body>
</html>
