<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>he will never forget</title>
    <style>
        /* --- GLOBAL & SETUP --- */
        :root {
            --bg-color: #000000;
            --text-color: #cccccc;
            --highlight-color: #990000;
            --pc-bg: #050510;
            --pc-monitor-bg: #1a1a2a;
            --pc-border: #333344;
            --pc-text: #00ff00;
            --pc-text-dim: #008800;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Courier New', Courier, monospace;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            visibility: hidden;
            transition: opacity 1s ease-in-out, transform 1.2s ease-in-out;
            display: flex;
            flex-direction: column;
            /* justify-content: center; */ /* Removed to push PC to top */
            align-items: center;
        }

        .screen.active {
            opacity: 1;
            visibility: visible;
            z-index: 10;
        }

        button {
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.2rem;
            background: none;
            border: 1px solid var(--text-color);
            color: var(--text-color);
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            background: var(--highlight-color);
            color: #ffffff;
            border-color: var(--highlight-color);
        }

        h1 {
            color: var(--highlight-color);
            font-weight: normal;
            margin-bottom: 20px;
        }

        .pc-only { display: none; }
        .mobile-only { display: none; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* --- 1. INTRO SCREEN --- */
        #intro-screen {
            background: #000;
            z-index: 100;
            justify-content: center; /* Re-add center for intro only */
        }

        #studio-logo {
            font-size: 2rem;
            color: #555;
            opacity: 0; /* Start at 0 */
            animation: fadeInOut 5s forwards ease-in-out;
        }
        
        #loading-bar-container {
            width: 200px;
            height: 5px;
            border: 1px solid #444;
            margin-top: 20px;
            opacity: 0; /* Fade in with logo */
            animation: fadeIn 2s forwards 0.5s;
        }
        
        #loading-bar-fill {
            width: 0%;
            height: 100%;
            background-color: var(--text-color);
            animation: fillLoading 4s forwards 1s ease-out; /* Fill over 4s, after 1s delay */
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; }
            40% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        @keyframes fillLoading {
            from { width: 0%; }
            to { width: 100%; }
        }

        #device-select {
            margin-top: 30px;
            opacity: 0; /* JS will fade this in */
        }

        #device-select h1 {
            font-size: 1.5rem;
            color: var(--text-color);
        }

        #device-select button {
            margin: 0 10px;
        }

        /* --- 2. MAIN ROOM --- */
        #room-screen {
            background-image: url('https://i.imgur.com/O9vg7SA.jpeg');
            background-size: cover;
            background-position: center;
            z-index: 5;
            transform: scale(1);
            justify-content: center; /* Re-add center for room only */
        }

        #computer-hotspot {
            position: absolute;
            /* Visually targeting the PC monitor in the upper-right */
            top: 25%;
            left: 55%;
            width: 30%;
            height: 35%;
            cursor: pointer;
            transition: background-color 0.3s;
            /* border: 1px dashed red; */ /* Uncomment to debug hotspot */
        }

        #computer-hotspot:hover {
            background-color: rgba(255, 0, 0, 0.1);
        }

        /* --- 3. PC VIEW --- */
        #pc-screen {
            background: var(--pc-bg);
            z-index: 20;
            transform: scale(1.1); /* Start slightly zoomed for transition */
            padding-top: 2vh; /* Push PC desktop to top */
        }

        #pc-screen.active {
            transform: scale(1);
        }

        #pc-desktop {
            width: 98vw; /* Pushed to edge */
            height: 96vh; /* Pushed to edge */
            /* max-width: 1200px; */ /* Removed */
            /* max-height: 800px; */ /* Removed */
            background: var(--pc-monitor-bg);
            border: 10px solid #111;
            border-radius: 5px;
            box-shadow: 0 0 30px rgba(150, 150, 250, 0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        #pc-main-area {
            display: flex;
            flex-grow: 1;
            margin-top: 20px;
            gap: 20px;
            overflow: hidden;
        }
        
        #pc-sidebar {
            width: 150px;
            flex-shrink: 0;
            padding: 10px;
            border: 1px solid var(--pc-border);
            background: #000;
        }
        
        .pc-icon {
            color: var(--pc-text-dim);
            cursor: pointer;
            margin-bottom: 15px;
            font-size: 1rem;
        }
        .pc-icon:before {
            content: '[ ] ';
        }
        .pc-icon:hover, .pc-icon.active {
            color: var(--pc-text);
        }
        .pc-icon.active:before {
            content: '[x] ';
        }

        #pc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--pc-border);
            padding-bottom: 10px;
            color: #8899ff;
        }

        #task-count {
            color: #ffff00;
        }

        #task-container {
            flex-grow: 1;
            padding: 15px;
            background: #000;
            border: 1px solid var(--pc-border);
            overflow-y: auto;
            font-size: 1.1rem;
            color: var(--pc-text);
        }

        #pc-controls {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 2px solid var(--pc-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #pc-power-off {
            background: var(--highlight-color);
            color: white;
            border-color: var(--highlight-color);
            font-size: 0.9rem;
        }
        #pc-power-off:hover {
            background: #ff0000;
        }
        
        #pc-rebooting {
            display: none;
            color: var(--pc-text);
            font-size: 1.5rem;
            text-align: center;
        }

        #reboot-bar-container {
            width: 80%;
            height: 30px;
            border: 2px solid var(--pc-text);
            margin-top: 20px;
        }

        #reboot-bar-fill {
            width: 0%;
            height: 100%;
            background: var(--pc-text);
            transition: width 0.1s linear;
        }

        /* --- PC TASKS STYLING --- */
        .task-description {
            color: var(--pc-text);
            margin-bottom: 20px;
        }
        .task-description strong {
            color: #ffff00;
        }

        #task-type-input {
            width: 100%;
            background: #222;
            border: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.2rem;
            padding: 10px;
            margin-top: 10px;
        }

        #task-type-code {
            color: #ff0;
            font-size: 1.3rem;
            letter-spacing: 2px;
            word-wrap: break-word;
        }

        #task-reaction-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
            max-width: 330px;
        }

        .reaction-square {
            width: 100px;
            height: 100px;
            background: #333;
            border: 2px solid #555;
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .reaction-square.target {
            background: var(--pc-text);
        }
        
        #task-pacman-grid {
            font-family: monospace;
            font-size: 1.5rem;
            line-height: 1.1;
            white-space: pre;
            background: #000;
            border: 2px solid var(--pc-text-dim);
            padding: 5px;
            user-select: none;
        }
        .pac-player { color: #ff0; }
        .pac-ghost { color: #f00; }
        .pac-dot { color: #fff; }
        .pac-wall { color: #00f; }

        #task-stabilize-container {
            width: 100%;
            height: 60px;
            background: #222;
            border: 2px solid var(--pc-border);
            margin-top: 20px;
            position: relative;
            overflow: hidden;
        }
        #task-stabilize-target {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 15%;
            height: 100%;
            background: rgba(0, 255, 0, 0.3);
            border-left: 2px solid var(--pc-text);
            border-right: 2px solid var(--pc-text);
        }
        #task-stabilize-bar {
            position: absolute;
            left: 50%;
            width: 10px;
            height: 100%;
            background: #ff0;
            box-shadow: 0 0 10px #ff0;
        }

        /* --- HUD & UI --- */
        #pills-hud {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 30;
            transition: transform 0.2s ease;
        }
        #pills-hud:active {
            transform: translateX(-50%) scale(0.95);
        }

        #pill-icon {
            width: 30px;
            height: 30px;
            filter: brightness(0.8);
        }

        #pill-count {
            font-size: 1.8rem;
            color: #ffffff;
            margin-left: 15px;
            font-weight: bold;
        }

        #mobile-back-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            background: rgba(100, 0, 0, 0.7);
            color: #fff;
            border-radius: 5px;
            z-index: 30;
            cursor: pointer;
        }

        #tips-hud {
            position: absolute;
            bottom: 120px;
            width: 100%;
            text-align: center;
            color: #aaa;
            font-size: 1.1rem;
            font-style: italic;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            pointer-events: none;
            z-index: 30;
        }

        /* --- 4. GAME OVER / WIN SCREENS --- */
        #game-over-screen, #win-screen {
            background: #000;
            z-index: 9998;
            justify-content: center; /* Re-add center for end screens */
        }
        #game-over-screen h1, #win-screen h1 {
            text-align: center;
            font-size: 2rem;
        }
        #game-over-screen button, #win-screen button {
            margin-top: 30px;
        }

        /* --- 5. EFFECTS & OVERLAYS --- */
        #flicker-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.05);
            opacity: 0;
            z-index: 2;
            pointer-events: none;
            animation: flicker 4s infinite alternate step-end;
        }
        
        #panic-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, transparent 70%, rgba(0,0,0,0) 80%, rgba(255,0,0,0.1) 95%);
            opacity: 0;
            z-index: 25;
            pointer-events: none;
            transition: opacity 1.5s ease, background 1.5s ease;
        }

        /* High Panic Effects */
        .high-panic-blur {
            filter: blur(1px);
        }
        .high-panic-shake {
            animation: shake 0.3s infinite;
        }
        .extreme-panic-filter {
            filter: blur(1.5px) contrast(1.1) brightness(0.9);
        }

        @keyframes flicker {
            0%, 100% { opacity: 0; }
            5% { opacity: 1; }
            10% { opacity: 0; }
            30% { opacity: 1; }
            32% { opacity: 0; }
            60% { opacity: 0; }
            61% { opacity: 0.5; }
            62% { opacity: 0; }
        }

        @keyframes shake {
            /* More aggressive shake */
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(3px, -2px); }
            50% { transform: translate(-2px, 3px); }
            75% { transform: translate(2px, -3px); }
        }

        /* --- 6. JUMPSCARE --- */
        #jumpscare-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: 9999;
            display: none;
            background: #000;
        }

        /* --- RESPONSIVENESS --- */
        @media (max-width: 768px) {
            #computer-hotspot {
                /* Adjust for mobile view of image */
                top: 28%;
                left: 50%;
                width: 40%;
                height: 35%;
            }
            #pills-hud {
                bottom: 20px;
            }
            #tips-hud {
                bottom: 90px;
                font-size: 0.9rem;
            }
            .reaction-square {
                width: 80px;
                height: 80px;
            }
            #pc-desktop {
                width: 100%;
                height: 100%;
                max-width: 100%;
                max-height: 100%;
                border: none;
                border-radius: 0;
                padding: 10px;
            }
            #pc-controls {
                flex-direction: column;
                gap: 10px;
            }
            #pc-main-area {
                flex-direction: column;
            }
            #pc-sidebar {
                width: 100%;
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                height: auto;
            }
        }
    </style>
</head>
<body>

    <div id="game-container">

        <div id="intro-screen" class="screen active">
            <div id="studio-logo">Silent Studio</div>
            <div id="loading-bar-container">
                <div id="loading-bar-fill"></div>
            </div>
            <div id="device-select" style="display: none;">
                <h1>Choose your device:</h1>
                <button id="btn-pc">PC</button> | <button id="btn-mobile">Mobile</button>
            </div>
        </div>

        <div id="room-screen" class="screen">
            <div id="computer-hotspot"></div>
            </div>

        <div id="pc-screen" class="screen">
            <div id="pc-desktop" style="display: none;">
                <div id="pc-header">
                    <h3>TASKS REMAINING: <span id="task-count">10</span></h3>
                    <span id="pc-time">00:00</span>
                </div>
                <div id="pc-main-area">
                    <div id="pc-sidebar">
                        <div class="pc-icon active" data-view="tasks">Tasks</div>
                        <div class="pc-icon" data-view="logs">Logs</div>
                    </div>
                    <div id="task-container">
                        </div>
                </div>
                <div id="pc-controls">
                    <span class="pc-only">Press ESC to leave PC</span>
                    <span class="mobile-only">Use 'Back' button to leave</span>
                    <button id="pc-power-off">Turn Off PC</button>
                </div>
            </div>
            <div id="pc-rebooting" style="display: none;">
                <p>Rebooting PC...</p>
                <div id="reboot-bar-container">
                    <div id="reboot-bar-fill"></div>
                </div>
            </div>
        </div>

        <div id="game-over-screen" class="screen">
            <h1>GAME OVER</h1>
            <button id="restart-btn">Restart</button>
        </div>

        <div id="win-screen" class="screen">
            <h1>You remembered everything.</h1>
            <h1>But at what cost?</h1>
            <button id="restart-btn-win">Restart</button>
        </div>

        <div id="pills-hud" style="display: none;">
            <img id="pill-icon" src="https://i.imgur.com/vz9eh1m.jpeg" alt="Pills">
            <span id="pill-count">5</span>
        </div>
        
        <div id="mobile-back-btn" class="mobile-only" style="display: none; z-index: 30;">Back</div>
        <div id="tips-hud"></div>
        <div id="flicker-overlay"></div>
        <div id="panic-overlay"></div>

        <video id="jumpscare-video" src="https://files.catbox.moe/cskqo9.mov" playsinline preload="auto"></video>

        <audio id="audio-breathing" src="https://files.catbox.moe/crj8v7.mp3" loop preload="auto"></audio>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- DOM ELEMENTS ---
            const $ = document.getElementById.bind(document);
            
            const DOM = {
                gameContainer: $('game-container'),
                screens: {
                    intro: $('intro-screen'),
                    room: $('room-screen'),
                    pc: $('pc-screen'),
                    gameOver: $('game-over-screen'),
                    win: $('win-screen')
                },
                studioLogo: $('studio-logo'),
                loadingBar: $('loading-bar-container'),
                deviceSelect: $('device-select'),
                btnPC: $('btn-pc'),
                btnMobile: $('btn-mobile'),
                computerHotspot: $('computer-hotspot'),
                pillsHUD: $('pills-hud'),
                pillCount: $('pill-count'),
                mobileBackBtn: $('mobile-back-btn'),
                tipsHUD: $('tips-hud'),
                pcDesktop: $('pc-desktop'),
                pcRebooting: $('pc-rebooting'),
                rebootBarFill: $('reboot-bar-fill'),
                taskCount: $('task-count'),
                pcTime: $('pc-time'),
                taskContainer: $('task-container'),
                pcPowerOff: $('pc-power-off'),
                pcSidebar: $('pc-sidebar'),
                panicOverlay: $('panic-overlay'),
                jumpscareVideo: $('jumpscare-video'),
                audioBreathing: $('audio-breathing')
            };

            // --- GAME STATE ---
            const Game = {
                device: 'pc',
                currentView: 'intro',
                pills: 5,
                tasksCompleted: 0,
                tasksTotal: 10,
                pcOn: true,
                pcRebooting: false,
                gameRunning: false,
                gameOver: false,
                currentPCView: 'tasks',
                timers: {},
                tips: [
                    "Take pills to stay calm.",
                    "The breathing is getting closer...",
                    "You can't stay here forever.",
                    "You must complete the tasks.",
                    "Turning off the PC helps... but wastes time.",
                    "What did you do?",
                    "She won't let you forget.",
                    "Where am I?",
                    "Why is she here?",
                    "It was an accident...",
                    "I... I didn't mean to."
                ],

                init() {
                    // Fix startup bug: Wait for animations, then show device select
                    setTimeout(() => {
                        DOM.studioLogo.style.display = 'none';
                        DOM.loadingBar.style.display = 'none';
                        DOM.deviceSelect.style.display = 'block';
                        DOM.deviceSelect.style.animation = 'fadeIn 2s forwards';
                    }, 5100);

                    DOM.btnPC.addEventListener('click', () => this.startGame('pc'));
                    DOM.btnMobile.addEventListener('click', () => this.startGame('mobile'));
                },

                startGame(device) {
                    this.device = device;
                    AudioManager.init();
                    
                    if (device === 'mobile') {
                        document.querySelectorAll('.mobile-only').forEach(el => el.style.display = 'block');
                    } else {
                        document.querySelectorAll('.pc-only').forEach(el => el.style.display = 'block');
                    }

                    DOM.pillsHUD.style.display = 'flex';
                    this.showScreen('room');
                    this.startGameLoop();
                },

                showScreen(screenName) {
                    Object.values(DOM.screens).forEach(s => s.classList.remove('active'));
                    if (DOM.screens[screenName]) {
                        DOM.screens[screenName].classList.add('active');
                        this.currentView = screenName;
                    }
                },

                startGameLoop() {
                    if (this.gameRunning) return;
                    this.gameRunning = true;

                    PanicManager.start();
                    UIManager.start();
                    
                    // Random ambient events (more frequent)
                    this.timers.ambient = setTimeout(this.triggerRandomEvent, 15000 + Math.random() * 20000); // 15-35s
                },

                stopGameLoop() {
                    this.gameRunning = false;
                    Object.values(this.timers).forEach(timer => {
                        if (timer) clearInterval(timer);
                        if (timer) clearTimeout(timer);
                    });
                    PanicManager.stop();
                    UIManager.stop();
                },
                
                triggerRandomEvent() {
                    if (Game.gameOver) return;
                    
                    // Visual flicker
                    const flicker = $('flicker-overlay');
                    flicker.style.animation = 'none';
                    void flicker.offsetWidth; // Trigger reflow
                    flicker.style.animation = 'flicker 0.2s 1 step-end';
                    
                    // Random sound
                    if (Math.random() > 0.3) {
                        AudioManager.playCreak();
                    } else if (Math.random() > 0.5) {
                        AudioManager.playStatic();
                    }

                    // Reschedule (more frequent)
                    Game.timers.ambient = setTimeout(Game.triggerRandomEvent, 20000 + Math.random() * 20000); // 20-40s
                },

                win() {
                    if (this.gameOver) return;
                    console.log("YOU WIN");
                    this.gameOver = true;
                    this.stopGameLoop();
                    AudioManager.stopAll();

                    PCManager.leavePCView();
                    setTimeout(() => {
                        this.showScreen('win');
                    }, 1500); // Wait for zoom out
                },
                
                lose() {
                    if (this.gameOver) return;
                    console.log("GAME OVER");
                    this.gameOver = true;
                    this.stopGameLoop();

                    // Reset all visuals
                    DOM.gameContainer.className = '';
                    DOM.panicOverlay.style.opacity = 0;
                    Object.values(DOM.screens).forEach(s => s.classList.remove('active'));

                    // Stop all audio
                    AudioManager.stopAll();
                    
                    // Play jumpscare
                    DOM.jumpscareVideo.style.display = 'block';
                    DOM.jumpscareVideo.currentTime = 0;
                    DOM.jumpscareVideo.play().catch(e => {
                        console.error("Jumpscare video failed to play", e);
                        this.showGameOverScreen(); // Fallback
                    });
                },

                showGameOverScreen() {
                    DOM.jumpscareVideo.style.display = 'none';
                    this.showScreen('gameOver');
                }
            };

            // --- AUDIO HANDLING ---
            const AudioManager = {
                audioCtx: null,
                ambientHum: null,
                breathing: DOM.audioBreathing,

                init() {
                    if (this.audioCtx) return;
                    try {
                        this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                        
                        // Create low ambient hum
                        const oscillator = this.audioCtx.createOscillator();
                        const gainNode = this.audioCtx.createGain();
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(50, this.audioCtx.currentTime); // 50Hz hum
                        gainNode.gain.setValueAtTime(0.02, this.audioCtx.currentTime); // Very quiet
                        oscillator.connect(gainNode).connect(this.audioCtx.destination);
                        oscillator.start();
                        this.ambientHum = oscillator;

                        // Prepare other sounds
                        this.breathing.play().then(() => this.breathing.pause()).catch(e => {});
                        DOM.jumpscareVideo.load();

                    } catch (e) {
                        console.error("Web Audio API is not supported in this browser", e);
                    }
                },
                
                playOneShot(type) {
                    if (!this.audioCtx) return;
                    try {
                        let duration, buffer, data;
                        const sampleRate = this.audioCtx.sampleRate;
                        
                        if (type === 'creak') {
                            duration = Math.random() * 0.3 + 0.2;
                            buffer = this.audioCtx.createBuffer(1, sampleRate * duration, sampleRate);
                            data = buffer.getChannelData(0);
                            for (let i = 0; i < data.length; i++) {
                                data[i] = (Math.random() * 2 - 1) * (1 - i / data.length) * 0.1; // Fading noise
                            }
                            
                            const noise = this.audioCtx.createBufferSource();
                            noise.buffer = buffer;
                            const bqFilter = this.audioCtx.createBiquadFilter();
                            bqFilter.type = "lowpass";
                            bqFilter.frequency.setValueAtTime(600 + Math.random() * 400, this.audioCtx.currentTime);
                            noise.connect(bqFilter).connect(this.audioCtx.destination);
                            noise.start();
                        }
                        else if (type === 'static') {
                            duration = 0.15;
                            buffer = this.audioCtx.createBuffer(1, sampleRate * duration, sampleRate);
                            data = buffer.getChannelData(0);
                            for (let i = 0; i < data.length; i++) {
                                data[i] = (Math.random() * 2 - 1) * 0.05; // White noise
                            }
                            const staticNoise = this.audioCtx.createBufferSource();
                            staticNoise.buffer = buffer;
                            staticNoise.connect(this.audioCtx.destination);
                            staticNoise.start();
                        }

                    } catch(e) { console.warn("Could not play sound", e); }
                },

                playCreak() { this.playOneShot('creak'); },
                playStatic() { this.playOneShot('static'); },

                startBreathing() {
                    this.breathing.currentTime = 0;
                    this.breathing.volume = 0.8; // Start louder
                    this.breathing.play().catch(e => console.warn("Breathing audio failed"));
                },
                
                setBreathingVolume(vol) {
                    this.breathing.volume = vol;
                },

                stopBreathing() {
                    this.breathing.pause();
                },

                stopAll() {
                    this.stopBreathing();
                    if (this.ambientHum) this.ambientHum.stop();
                }
            };

            // --- PANIC SYSTEM ---
            const PanicManager = {
                panic: 0,
                highPanicActive: false,
                extremePanicActive: false,
                
                start() {
                    Game.timers.panic = setInterval(this.update.bind(this), 1000);
                },
                
                stop() {
                    clearInterval(Game.timers.panic);
                },

                update() {
                    if (Game.gameOver || Game.pcRebooting) return;

                    let panicIncrease = 0.2; // More aggressive
                    if (Game.pills <= 2) panicIncrease = 0.35;
                    if (Game.pills === 0) panicIncrease = 0.6; // More aggressive
                    if (Game.currentView === 'pc' && Game.pcOn) panicIncrease *= 2.5; // More aggressive

                    if (!Game.pcOn && Game.currentView === 'room') {
                        this.panic = Math.max(0, this.panic - 0.2);
                    } else {
                        this.panic = Math.min(100, this.panic + panicIncrease);
                    }
                    
                    this.checkState();
                },

                checkState() {
                    // Level 1: Subtle Vignette
                    if (this.panic >= 60) {
                        DOM.panicOverlay.style.opacity = (this.panic - 60) / 40 * 0.5; // 0 to 0.5
                    } else {
                        DOM.panicOverlay.style.opacity = 0;
                    }

                    // Level 2: High Panic (Breathing, Blur, Shake) - Starts earlier
                    if (this.panic >= 75 && !this.highPanicActive) {
                        this.highPanicActive = true;
                        AudioManager.startBreathing();
                        DOM.gameContainer.classList.add('high-panic-blur', 'high-panic-shake');
                        DOM.panicOverlay.style.background = 'radial-gradient(circle, transparent 60%, rgba(255,0,0,0.3) 100%)';
                        UIManager.showTip("The breathing is getting closer...");
                    } else if (this.panic < 75 && this.highPanicActive) {
                        this.highPanicActive = false;
                        this.extremePanicActive = false; // Also reset extreme
                        AudioManager.stopBreathing();
                        DOM.gameContainer.classList.remove('high-panic-blur', 'high-panic-shake', 'extreme-panic-filter');
                        DOM.panicOverlay.style.background = 'radial-gradient(circle, transparent 70%, rgba(0,0,0,0) 80%, rgba(255,0,0,0.1) 95%)';
                    }

                    // Level 3: Extreme Panic - Starts earlier
                    if (this.panic >= 85 && !this.extremePanicActive) {
                        this.extremePanicActive = true;
                        DOM.gameContainer.classList.add('extreme-panic-filter');
                    } else if (this.panic < 85 && this.extremePanicActive) {
                        this.extremePanicActive = false;
                        DOM.gameContainer.classList.remove('extreme-panic-filter');
                    }
                    
                    // Adjust effects based on panic
                    if(this.highPanicActive) {
                        DOM.panicOverlay.style.opacity = 0.4 + (this.panic - 75) / 25 * 0.6;
                        // Volume ramp from 0.8 to 1.0
                        AudioManager.setBreathingVolume(0.8 + (this.panic - 75) / 25 * 0.2);
                    }

                    if (this.panic >= 100) {
                        Game.lose();
                    }
                },
                
                takePill() {
                    if (Game.pills > 0 && !Game.gameOver) {
                        Game.pills--;
                        DOM.pillCount.textContent = Game.pills;
                        this.panic = Math.max(0, this.panic - 40); // Significant reduction
                        
                        // Jolt effect
                        DOM.gameContainer.style.transition = 'transform 0.1s';
                        DOM.gameContainer.style.transform = 'scale(1.02)';
                        setTimeout(() => DOM.gameContainer.style.transform = 'scale(1)', 100);

                        this.checkState(); // Update visuals immediately
                        
                        if (Game.pills === 0) {
                            UIManager.showTip("You are out of pills... you're on your own.");
                        }
                    }
                }
            };
            
            // --- UI & HUD ---
            const UIManager = {
                start() {
                    Game.timers.tip = setInterval(this.showRandomTip.bind(this), 35000);
                    setTimeout(() => this.showTip("Take pills to stay calm."), 5000);
                },
                
                stop() {
                    clearInterval(Game.timers.tip);
                },
                
                showTip(message) {
                    DOM.tipsHUD.textContent = message;
                    DOM.tipsHUD.style.opacity = 1;
                    setTimeout(() => {
                        DOM.tipsHUD.style.opacity = 0;
                    }, 5000);
                },

                showRandomTip() {
                    if (Game.gameOver) return;
                    const tip = Game.tips[Math.floor(Math.random() * Game.tips.length)];
                    this.showTip(tip);
                }
            };
            
            // --- ROOM & PC INTERACTIONS ---
            const PCManager = {
                pcClockTimer: null,
                
                init() {
                    DOM.computerHotspot.addEventListener('click', this.enterPCView.bind(this));
                    DOM.mobileBackBtn.addEventListener('click', this.leavePCView.bind(this));
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && Game.device === 'pc' && Game.currentView === 'pc') {
                            this.leavePCView();
                        }
                    });
                    
                    DOM.pcPowerOff.addEventListener('click', this.turnOffPC.bind(this));
                    
                    // Sidebar navigation
                    DOM.pcSidebar.addEventListener('click', (e) => {
                        if (e.target.classList.contains('pc-icon')) {
                            this.navigate(e.target.dataset.view);
                        }
                    });
                },
                
                navigate(view) {
                    DOM.pcSidebar.querySelectorAll('.pc-icon').forEach(icon => icon.classList.remove('active'));
                    DOM.pcSidebar.querySelector(`.pc-icon[data-view="${view}"]`).classList.add('active');
                    Game.currentPCView = view;
                    
                    if (view === 'tasks') {
                        TaskManager.loadCurrentTask();
                    } else if (view === 'logs') {
                        this.showLogs();
                    }
                },
                
                showLogs() {
                    TaskManager.clearTask();
                    DOM.taskContainer.innerHTML = `
                        <p class="task-description">PERSONAL LOGS</p>
                        <p><strong>Entry 01:</strong> My head... hurts. Where am I? This room... I don't recognize it. Need to focus. The terminal. Maybe it has answers.</p>
                        <br>
                        <p><strong>Entry 02:</strong> I keep hearing things. A... a creak. A whisper. Just my mind playing tricks. The pills help. For now.</p>
                        <br>
                        <p><strong>Entry 03:</strong> It's her. It's... it can't be. She's gone. I know she is. So why do I hear her breathing? Why won't she leave me alone?</p>
                        <br>
                        <p><strong>Entry 04:</strong> The tasks. They're like... memories. Fragments. I have to do them. I have to... what? Remember? Or forget?</p>
                        <br>
                        <p><strong>Entry 05:</strong> It wasn't my fault. It was an accident. It was... I... no... no... she... she fell. That's what happened. She fell.</p>
                        <br>
                        <p><strong>Entry 06:</strong> ...he will never forget... he will never forget... HE WILL NEVER FORGET</p>
                    `;
                },

                enterPCView() {
                    if (Game.currentView === 'pc' || Game.gameOver) return;

                    Game.currentView = 'pc';
                    // Updated transform to aim at the new, higher hotspot
                    DOM.screens.room.style.transform = "scale(3.5) translate(-15%, -25%)"; 
                    DOM.screens.room.style.opacity = 0.5;
                    DOM.screens.pc.classList.add('active');
                    
                    if (Game.pcRebooting) return;

                    if (!Game.pcOn) {
                        DOM.pcDesktop.style.display = 'none';
                        DOM.pcRebooting.style.display = 'block';
                        this.runRebootSequence();
                    } else {
                        DOM.pcDesktop.style.display = 'flex';
                        DOM.pcRebooting.style.display = 'none';
                        this.navigate(Game.currentPCView); // Load current view
                        this.startPCClock();
                    }
                },

                leavePCView() {
                    if (Game.currentView !== 'pc' || Game.gameOver) return;
                    
                    Game.currentView = 'room';
                    DOM.screens.room.style.transform = "scale(1) translate(0, 0)";
                    DOM.screens.room.style.opacity = 1;
                    DOM.screens.pc.classList.remove('active');
                    this.stopPCClock();
                    TaskManager.clearTask(); // Stop any running task intervals
                },

                turnOffPC() {
                    if (!Game.pcOn) return;
                    Game.pcOn = false;
                    TaskManager.clearTask();
                    TaskManager.currentTask = null; // <-- BUG FIX: Clear current task
                    UIManager.showTip("PC shutting down. Things feel... quieter.");
                    this.leavePCView();
                },

                runRebootSequence() {
                    if (Game.pcRebooting) return;
                    Game.pcRebooting = true;
                    
                    const rebootDuration = 15000; // 15 seconds (was 30)
                    DOM.rebootBarFill.style.transition = `width ${rebootDuration}ms linear`;
                    DOM.rebootBarFill.style.width = '100%';

                    setTimeout(() => {
                        Game.pcOn = true;
                        Game.pcRebooting = false;
                        DOM.rebootBarFill.style.transition = 'none';
                        DOM.rebootBarFill.style.width = '0%';

                        if (Game.currentView === 'pc') {
                            DOM.pcDesktop.style.display = 'flex';
                            DOM.pcRebooting.style.display = 'none';
                            this.navigate('tasks');
                            this.startPCClock();
                        }
                    }, rebootDuration);
                },

                startPCClock() {
                    let time = 0;
                    if (this.pcClockTimer) clearInterval(this.pcClockTimer);
                    this.pcClockTimer = setInterval(() => {
                        time++;
                        const minutes = String(Math.floor(time / 60)).padStart(2, '0');
                        const seconds = String(time % 60).padStart(2, '0');
                        DOM.pcTime.textContent = `${minutes}:${seconds}`;
                    }, 1000);
                },

                stopPCClock() {
                    if (this.pcClockTimer) clearInterval(this.pcClockTimer);
                    this.pcClockTimer = null;
                }
            };
            
            // --- TASK MANAGEMENT ---
            const TaskManager = {
                currentTask: null,
                currentTaskCleanup: null,
                
                tasks: [
                    { name: "Type Code", init: "task_typeCode" },
                    { name: "Reaction Test", init: "task_clickReaction" },
                    { name: "Stabilize", init: "task_stabilize" },
                    { name: "Pac-Man", init: "task_pacman" }
                ],
                
                loadCurrentTask() {
                    if (Game.currentPCView !== 'tasks') return;
                    
                    if (this.currentTask) {
                        // Task in progress, re-render it
                        const initFunc = this.taskImplementations[this.currentTask.init];
                        if(initFunc) {
                            initFunc.call(this.taskImplementations);
                        } else {
                            // Task is stale or bad, load next
                            this.loadNextTask();
                        }
                    } else {
                        // Load next task
                        this.loadNextTask();
                    }
                },
                
                loadNextTask: function() {
                    if (Game.tasksCompleted >= Game.tasksTotal) {
                        Game.win();
                        return;
                    }

                    this.clearTask();
                    DOM.taskContainer.innerHTML = '<h3>Loading new task...</h3>';
                    
                    setTimeout(() => {
                        if (Game.currentPCView !== 'tasks') return; // User navigated away
                        
                        const taskIndex = Game.tasksCompleted % this.tasks.length;
                        this.currentTask = this.tasks[taskIndex];
                        
                        // Dynamically call the init function by its name
                        const initFunc = this.taskImplementations[this.currentTask.init];
                        if(initFunc) {
                            initFunc.call(this.taskImplementations);
                        } else {
                            console.error("Task init function not found:", this.currentTask.init);
                        }
                    }, 1000 + Math.random() * 1500);
                },
                
                clearTask() {
                    if (this.currentTaskCleanup) {
                        this.currentTaskCleanup();
                        this.currentTaskCleanup = null;
                    }
                    DOM.taskContainer.innerHTML = '';
                },

                completeTask: function() {
                    if (Game.gameOver) return; // Prevent calls after game end
                    this.clearTask();
                    
                    Game.tasksCompleted++;
                    this.currentTask = null;
                    DOM.taskCount.textContent = Game.tasksTotal - Game.tasksCompleted;
                    DOM.taskContainer.innerHTML = `<h2 style="color: #0f0;">TASK COMPLETE.</h2><p>Calibrating next module...</p>`;
                    
                    // Give a small panic reward
                    PanicManager.panic = Math.max(0, PanicManager.panic - 5);
                    
                    setTimeout(() => {
                        if(Game.currentPCView === 'tasks' && !Game.gameOver) {
                            this.loadNextTask();
                        }
                    }, 2000);
                },

                // --- TASK IMPLEMENTATIONS ---
                taskImplementations: {
                    task_typeCode() {
                        const code = Array(15).fill(0).map(() => "abcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(Math.random() * 36))).join('');
                        DOM.taskContainer.innerHTML = `
                            <p class="task-description">SECURITY PROTOCOL: Type the following verification code exactly:</p>
                            <h3 id="task-type-code">${code}</h3>
                            <input type="text" id="task-type-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                        `;
                        
                        const input = $('task-type-input');
                        input.focus();

                        const keyHandler = (e) => {
                            if (e.target.value === code) {
                                TaskManager.completeTask();
                            } else if (code.startsWith(e.target.value)) {
                                input.style.borderColor = '#444';
                            } else {
                                input.style.borderColor = 'red';
                            }
                        };
                        input.addEventListener('keyup', keyHandler);
                        
                        TaskManager.currentTaskCleanup = () => {
                            input.removeEventListener('keyup', keyHandler);
                        };
                    },

                    task_clickReaction() {
                        DOM.taskContainer.innerHTML = `
                            <p class="task-description">REFLEX CALIBRATION: Click the <strong>green</strong> square as fast as possible.</p>
                            <div id="task-reaction-grid">
                                ${Array(9).fill(0).map(() => `<div class="reaction-square"></div>`).join('')}
                            </div>
                        `;

                        const squares = DOM.taskContainer.querySelectorAll('.reaction-square');
                        const timeoutId = setTimeout(() => {
                            const targetIndex = Math.floor(Math.random() * squares.length);
                            squares[targetIndex].classList.add('target');
                            squares[targetIndex].addEventListener('click', () => TaskManager.completeTask(), { once: true });
                        }, 1500 + Math.random() * 3000);

                        TaskManager.currentTaskCleanup = () => {
                            clearTimeout(timeoutId);
                            squares.forEach(sq => sq.replaceWith(sq.cloneNode(true)));
                        };
                    },
                    
                    task_pacman() {
                        DOM.taskContainer.innerHTML = `
                            <p class="task-description">DATA FRAGMENT RECOVERY: Collect all dots (<strong>.</strong>). Avoid the <strong>G</strong>host.</p>
                            <div id="task-pacman-grid"></div>
                            <p>Use <strong>Arrow Keys</strong> or <strong>W,A,S,D</strong> to move.</p>
                        `;
                        
                        const gridEl = $('task-pacman-grid');
                        const grid = [
                            "##########",
                            "#P.......#",
                            "#.###..G.#",
                            "#...#....#",
                            "##########",
                        ];
                        let player = {x: 1, y: 1};
                        let ghost = {x: 7, y: 2};
                        let dots = 12;

                        function drawGrid() {
                            gridEl.innerHTML = grid.map((row, y) => {
                                return row.split('').map((cell, x) => {
                                    if (x === player.x && y === player.y) return '<span class="pac-player">P</span>';
                                    if (x === ghost.x && y === ghost.y) return '<span class="pac-ghost">G</span>';
                                    if (cell === '.') return '<span class="pac-dot">.</span>';
                                    if (cell === '#') return '<span class="pac-wall">#</span>';
                                    return ' ';
                                }).join('');
                            }).join('\n');
                        }
                        
                        function move(dx, dy) {
                            const newX = player.x + dx;
                            const newY = player.y + dy;
                            
                            if (grid[newY][newX] === '#') return;
                            
                            player.x = newX;
                            player.y = newY;
                            
                            if (grid[newY][newX] === '.') {
                                dots--;
                                grid[newY] = grid[newY].substring(0, newX) + ' ' + grid[newY].substring(newX + 1);
                                if (dots === 0) TaskManager.completeTask();
                            }
                            
                            if (player.x === ghost.x && player.y === ghost.y) {
                                // Caught, reset
                                TaskManager.loadCurrentTask(); // Just reload
                            }
                            
                            moveGhost();
                            drawGrid();
                        }
                        
                        function moveGhost() {
                            const dx = Math.sign(player.x - ghost.x);
                            const dy = Math.sign(player.y - ghost.y);
                            
                            // Simple random move
                            const move = Math.random() > 0.5 ? 'x' : 'y';
                            if (move === 'x' && grid[ghost.y][ghost.x + dx] !== '#') ghost.x += dx;
                            else if (move === 'y' && grid[ghost.y + dy][ghost.x] !== '#') ghost.y += dy;
                            else if (grid[ghost.y][ghost.x + dx] !== '#') ghost.x += dx; // fallback
                            else if (grid[ghost.y + dy][ghost.x] !== '#') ghost.y += dy; // fallback
                            
                            if (player.x === ghost.x && player.y === ghost.y) {
                                TaskManager.loadCurrentTask();
                            }
                        }
                        
                        const keyHandler = (e) => {
                            e.preventDefault();
                            switch(e.key) {
                                case 'ArrowUp': case 'w': move(0, -1); break;
                                case 'ArrowDown': case 's': move(0, 1); break;
                                case 'ArrowLeft': case 'a': move(-1, 0); break;
                                case 'ArrowRight': case 'd': move(1, 0); break;
                            }
                        };
                        
                        document.addEventListener('keydown', keyHandler);
                        TaskManager.currentTaskCleanup = () => {
                            document.removeEventListener('keydown', keyHandler);
                        };
                        drawGrid();
                    },
                    
                    task_stabilize() {
                        DOM.taskContainer.innerHTML = `
                            <p class="task-description">CORE OSCILLATOR: Keep the <strong>yellow bar</strong> inside the <strong>green target zone</strong> for <strong>5</strong> seconds.</p>
                            <div id="task-stabilize-container">
                                <div id="task-stabilize-target"></div>
                                <div id="task-stabilize-bar"></div>
                            </div>
                            <p>Press <strong>Spacebar</strong> to apply counter-thrust.</p>
                        `;
                        
                        const bar = $('task-stabilize-bar');
                        let pos = 50; // %
                        let velocity = 0;
                        let gravity = 0.08;
                        let thrust = -0.3;
                        let timeInZone = 0;
                        const targetTime = 5000; // 5 seconds
                        
                        let interval = setInterval(() => {
                            velocity += gravity;
                            pos += velocity;
                            
                            if (pos < 0) { pos = 0; velocity *= -0.4; }
                            if (pos > 100) { pos = 100; velocity *= -0.4; }
                            
                            bar.style.left = `${pos}%`;
                            
                            // Check if in zone
                            if (pos > 42.5 && pos < 57.5) {
                                timeInZone += 20;
                                DOM.taskContainer.querySelector('.task-description').innerHTML = `CORE OSCILLATOR: ... ${((timeInZone / targetTime) * 100).toFixed(0)}%`;
                                if (timeInZone >= targetTime) {
                                    TaskManager.completeTask();
                                }
                            } else {
                                timeInZone = 0; // Reset
                            }
                            
                        }, 20);
                        
                        const keyHandler = (e) => {
                            if (e.key === ' ' || e.code === 'Space') {
                                e.preventDefault();
                                velocity += thrust;
                            }
                        };
                        
                        document.addEventListener('keydown', keyHandler);
                        
                        TaskManager.currentTaskCleanup = () => {
                            clearInterval(interval);
                            document.removeEventListener('keydown', keyHandler);
                        };
                    }
                }
            };

            // --- EVENT LISTENERS ---
            DOM.pillsHUD.addEventListener('click', () => PanicManager.takePill());
            DOM.jumpscareVideo.addEventListener('ended', () => Game.showGameOverScreen());
            DOM.jumpscareVideo.addEventListener('error', () => Game.showGameOverScreen());
            $('restart-btn').addEventListener('click', () => location.reload());
            $('restart-btn-win').addEventListener('click', () => location.reload());
            
            // --- START GAME ---
            PCManager.init();
            TaskManager.taskImplementations.task_typeCode = TaskManager.taskImplementations.task_typeCode.bind(TaskManager);
            TaskManager.taskImplementations.task_clickReaction = TaskManager.taskImplementations.task_clickReaction.bind(TaskManager);
            TaskManager.taskImplementations.task_pacman = TaskManager.taskImplementations.task_pacman.bind(TaskManager);
            TaskManager.taskImplementations.task_stabilize = TaskManager.taskImplementations.task_stabilize.bind(TaskManager);
            Game.init();

        });
    </script>
</body>
</html>
