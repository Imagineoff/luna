<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-CS">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>he will never forget</title>
    <link rel="icon" href="https://i.imgur.com/nfdTlfO.jpeg" />
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #cccccc;
            --highlight-color: #990000;
            --pc-bg: #050510;
            --pc-monitor-bg: #1a1a2a;
            --pc-border: #333344;
            --pc-text: #00ff00;
            --pc-text-dim: #008800;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Courier New', Courier, monospace;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            visibility: hidden;
            transition: opacity 1s ease-in-out, transform 1.2s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .screen.active {
            opacity: 1;
            visibility: visible;
            z-index: 10;
        }

        button {
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.2rem;
            background: none;
            border: 1px solid var(--text-color);
            color: var(--text-color);
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }

        button:hover {
            background: var(--highlight-color);
            color: #ffffff;
            border-color: var(--highlight-color);
        }

        h1 {
            color: var(--highlight-color);
            font-weight: normal;
            margin-bottom: 20px;
        }

        .pc-only { display: none; }
        .mobile-only { display: none; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        #intro-screen {
            background: #000;
            z-index: 100;
            justify-content: center;
        }

        #studio-logo {
            font-size: 2rem;
            color: #555;
            opacity: 0;
            animation: fadeInOut 5s forwards ease-in-out;
        }
        
        #loading-bar-container {
            width: 200px;
            height: 5px;
            border: 1px solid #444;
            margin-top: 20px;
            opacity: 0;
            animation: fadeIn 2s forwards 0.5s;
        }
        
        #loading-bar-fill {
            width: 0%;
            height: 100%;
            background-color: var(--text-color);
            animation: fillLoading 4s forwards 1s ease-out;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; }
            40% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        @keyframes fillLoading {
            from { width: 0%; }
            to { width: 100%; }
        }

        /* --- PŘIDÁNO PRO INTRO VIDEO --- */
        #intro-video {
            display: none;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        /* --- KONEC PŘIDÁNÍ --- */

        #device-select {
            margin-top: 30px;
            opacity: 0;
        }

        #device-select h1 {
            font-size: 1.5rem;
            color: var(--text-color);
        }

        #device-select button {
            margin: 0 10px;
        }

        #room-screen {
            background-image: url('https://i.imgur.com/O9vg7SA.jpeg');
            background-size: cover;
            background-position: center;
            z-index: 5;
            transform: scale(1);
            justify-content: center;
        }

        #room-screen.pc-off-state {
            background-image: url('https://raw.githubusercontent.com/Imagineoff/Imagineweb/main/PowerOFF.JPG');
        }

        #room-screen.pc-on-state {
            background-image: url('https://raw.githubusercontent.com/Imagineoff/Imagineweb/main/PowerON.JPG');
        }

        /* --- UPRAVENO --- */
        #computer-hotspot {
            position: absolute;
            top: 20%; /* Bylo 18% */
            left: 54%; /* Bylo 55% */
            width: 30%;
            height: 35%;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #computer-hotspot:hover {
            background-color: rgba(255, 0, 0, 0.1);
        }

        /* --- UPRAVENO --- */
        #power-strip-hotspot {
            position: absolute;
            bottom: 5%; /* Bylo 1% */
            left: 50%;
            transform: translateX(-50%);
            width: 15%;
            height: 6%;
            /* background-color: rgba(255, 0, 0, 0.2); */ /* Pro ladění */
            cursor: pointer;
            z-index: 10;
        }

        #pc-screen {
            background: var(--pc-bg);
            z-index: 20;
            transform: scale(1.1);
            /* padding-top: 1vh; */ /* ODEBRÁNO */
            justify-content: center; /* PŘIDÁNO */
        }

        #pc-screen.active {
            transform: scale(1);
        }

        #pc-desktop {
            width: 85vw;
            height: 90vh;
            max-width: 1100px;
            background: var(--pc-monitor-bg);
            border: 10px solid #111;
            border-radius: 5px;
            box-shadow: 0 0 30px rgba(150, 150, 250, 0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        #pc-main-area {
            display: flex;
            flex-grow: 1;
            margin-top: 20px;
            gap: 20px;
            overflow: hidden;
        }
        
        #pc-sidebar {
            width: 150px;
            flex-shrink: 0;
            padding: 10px;
            border: 1px solid var(--pc-border);
            background: #000;
        }
        
        .pc-icon {
            color: var(--pc-text-dim);
            cursor: pointer;
            margin-bottom: 15px;
            font-size: 1rem;
            touch-action: manipulation;
        }
        .pc-icon:before {
            content: '[ ] ';
        }
        .pc-icon:hover, .pc-icon.active {
            color: var(--pc-text);
        }
        .pc-icon.active:before {
            content: '[x] ';
        }

        #pc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--pc-border);
            padding-bottom: 10px;
            color: #8899ff;
        }

        #task-count {
            color: #ffff00;
        }

        #task-container {
            flex-grow: 1;
            padding: 15px;
            background: #000;
            border: 1px solid var(--pc-border);
            overflow-y: auto;
            font-size: 1.1rem;
            color: var(--pc-text);
        }

        #pc-controls {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 2px solid var(--pc-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #pc-power-off {
            background: var(--highlight-color);
            color: white;
            border-color: var(--highlight-color);
            font-size: 0.9rem;
            display: none; /* PŘIDÁNO - skryje staré tlačítko */
        }
        #pc-power-off:hover {
            background: #ff0000;
        }
        
        #pc-rebooting {
            display: none;
            color: var(--pc-text);
            font-size: 1.5rem;
            text-align: center;
        }

        #reboot-bar-container {
            width: 80%;
            height: 30px;
            border: 2px solid var(--pc-text);
            margin-top: 20px;
        }

        #reboot-bar-fill {
            width: 0%;
            height: 100%;
            background: var(--pc-text);
            transition: width 0.1s linear;
        }

        .task-description {
            color: var(--pc-text);
            margin-bottom: 20px;
        }
        .task-description strong {
            color: #ffff00;
        }

        #task-type-input {
            width: 100%;
            background: #222;
            border: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.2rem;
            padding: 10px;
            margin-top: 10px;
        }

        #task-type-code {
            color: #ff0;
            font-size: 1.3rem;
            letter-spacing: 2px;
            word-wrap: break-word;
        }

        #task-reaction-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
            max-width: 330px;
        }

        .reaction-square {
            width: 100px;
            height: 100px;
            background: #333;
            border: 2px solid #555;
            cursor: pointer;
            transition: background-color 0.1s;
            touch-action: manipulation;
        }
        .reaction-square.target {
            background: var(--pc-text);
        }
        
        #task-pacman-grid {
            font-family: monospace;
            font-size: 1.5rem;
            line-height: 1.1;
            white-space: pre;
            background: #000;
            border: 2px solid var(--pc-text-dim);
            padding: 5px;
            user-select: none;
        }
        .pac-player { color: #ff0; }
        .pac-ghost { color: #f00; }
        .pac-dot { color: #fff; }
        .pac-wall { color: #00f; }

        #task-stabilize-container {
            width: 100%;
            height: 60px;
            background: #222;
            border: 2px solid var(--pc-border);
            margin-top: 20px;
            position: relative;
            overflow: hidden;
        }
        #task-stabilize-target {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 15%;
            height: 100%;
            background: rgba(0, 255, 0, 0.3);
            border-left: 2px solid var(--pc-text);
            border-right: 2px solid var(--pc-text);
        }
        #task-stabilize-bar {
            position: absolute;
            left: 50%;
            width: 10px;
            height: 100%;
            background: #ff0;
            box-shadow: 0 0 10px #ff0;
        }

        #pills-container {
            position: absolute;
            left: 40%;
            top: 45%;
            transform: translate(-50%, -50%);
            z-index: 25;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        #pills-container:hover {
            transform: translate(-50%, -50%) scale(1.05);
        }

        #pills-container:active {
            transform: translate(-50%, -50%) scale(0.95);
        }

        #pill-image {
            width: 50px;
            height: 50px;
            background-image: url('https://raw.githubusercontent.com/Imagineoff/Imagineweb/main/Pills.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            touch-action: manipulation;
        }

        #pill-counter {
            font-size: 2rem;
            color: #ffffff;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        #mobile-back-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            background: rgba(100, 0, 0, 0.7);
            color: #fff;
            border-radius: 5px;
            z-index: 30;
            cursor: pointer;
            touch-action: manipulation;
        }

        #tips-hud {
            position: absolute;
            bottom: 120px;
            width: 100%;
            text-align: center;
            color: #aaa;
            font-size: 1.1rem;
            font-style: italic;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            pointer-events: none;
            z-index: 30;
        }

        #game-over-screen, #win-screen {
            background: #000;
            z-index: 9998;
            justify-content: center;
        }
        #game-over-screen h1, #win-screen h1 {
            text-align: center;
            font-size: 2rem;
        }
        #game-over-screen button, #win-screen button {
            margin-top: 30px;
        }

        #flicker-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.05);
            opacity: 0;
            z-index: 2;
            pointer-events: none;
            animation: flicker 4s infinite alternate step-end;
        }
        
        #panic-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, transparent 70%, rgba(0,0,0,0) 80%, rgba(255,0,0,0.1) 95%);
            opacity: 0;
            z-index: 25;
            pointer-events: none;
            transition: opacity 1.5s ease, background 1.5s ease;
        }

        .high-panic-blur {
            filter: blur(1px);
        }
        .high-panic-shake {
            animation: shake 0.3s infinite;
        }
        .extreme-panic-filter {
            filter: blur(1.5px) contrast(1.1) brightness(0.9);
        }

        @keyframes flicker {
            0%, 100% { opacity: 0; }
            5% { opacity: 1; }
            10% { opacity: 0; }
            30% { opacity: 1; }
            32% { opacity: 0; }
            60% { opacity: 0; }
            61% { opacity: 0.5; }
            62% { opacity: 0; }
        }

        @keyframes shake {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(3px, -2px); }
            50% { transform: translate(-2px, 3px); }
            75% { transform: translate(2px, -3px); }
        }

        #jumpscare-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: 9999;
            display: none;
            background: #000;
        }

        @media (max-width: 768px) {
            /* --- UPRAVENO --- */
            #computer-hotspot {
                top: 24%; /* Bylo 22% */
                left: 48%; /* Bylo 50% */
                width: 40%;
                height: 35%;
            }
            #pills-container {
                left: 35%;
                top: 40%;
            }
            #pill-image {
                width: 40px;
                height: 40px;
            }
            #pill-counter {
                font-size: 1.5rem;
            }
            #tips-hud {
                bottom: 90px;
                font-size: 0.9rem;
            }
            .reaction-square {
                width: 80px;
                height: 80px;
            }
            #pc-desktop {
                width: 100%;
                height: 100%;
                max-width: 100%;
                max-height: 100%;
                border: none;
                border-radius: 0;
                padding: 10px;
            }
            #pc-controls {
                flex-direction: column;
                gap: 10px;
            }
            #pc-main-area {
                flex-direction: column;
            }
            #pc-sidebar {
                width: 100%;
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                height: auto;
            }
        }

        @media (min-width: 769px) {
            .pc-only { display: block; }
        }

        @media (max-width: 768px) {
            .mobile-only { display: block; }
        }
    </style>
</head>
<body>

    <div id="game-container">

        <div id="intro-screen" class="screen active">
            <div id="studio-logo">Silent Studio</div>
            <div id="loading-bar-container">
                <div id="loading-bar-fill"></div>
            </div>
            <video id="intro-video" src="https://raw.githubusercontent.com/Imagineoff/Imagineweb/main/Intro.mp4" playsinline muted preload="auto"></video>
            <div id="device-select" style="display: none;">
                <h1>Choose your device:</h1>
                <button id="btn-pc">PC</button> | <button id="btn-mobile">Mobile</button>
            </div>
        </div>

        <div id="room-screen" class="screen">
            <div id="computer-hotspot"></div>
            <div id="power-strip-hotspot"></div>
            <div id="pills-container">
                <div id="pill-image"></div>
                <div id="pill-counter">5</div>
            </div>
        </div>

        <div id="pc-screen" class="screen">
            <div id="pc-desktop" style="display: none;">
                <div id="pc-header">
                    <h3>TASKS REMAINING: <span id="task-count">10</span></h3>
                    <span id="pc-time">00:00</span>
                </div>
                <div id="pc-main-area">
                    <div id="pc-sidebar">
                        <div class="pc-icon active" data-view="tasks">Tasks</div>
                        <div class="pc-icon" data-view="logs">Logs</div>
                    </div>
                    <div id="task-container">
                    </div>
                </div>
                <div id="pc-controls">
                    <span class="pc-only">Press ESC to leave PC</span>
                    <span class="mobile-only">Use 'Back' button to leave</span>
                    <button id="pc-power-off">Turn Off PC</button>
                </div>
            </div>
            <div id="pc-rebooting" style="display: none;">
                <p>Rebooting PC...</p>
                <div id="reboot-bar-container">
                    <div id="reboot-bar-fill"></div>
                </div>
            </div>
        </div>

        <div id="game-over-screen" class="screen">
            <h1>GAME OVER</h1>
            <button id="restart-btn">Restart</button>
        </div>

        <div id="win-screen" class="screen">
            <h1>You remembered everything.</h1>
            <h1>But at what cost?</h1>
            <button id="restart-btn-win">Restart</button>
        </div>

        <div id="mobile-back-btn" class="mobile-only" style="display: none;">Back</div>
        <div id="tips-hud"></div>
        <div id="flicker-overlay"></div>
        <div id="panic-overlay"></div>

        <video id="jumpscare-video" src="https://files.catbox.moe/cskqo9.mov" playsinline preload="auto"></video>

        <audio id="audio-breathing" src="https://files.catbox.moe/crj8v7.mp3" loop preload="auto"></audio>
        <audio id="audio-power-on" src="https://raw.githubusercontent.com/Imagineoff/Imagineweb/main/PowerON.mp3" loop preload="auto"></audio>
        <audio id="audio-power-off" src="https://raw.githubusercontent.com/Imagineoff/Imagineweb/main/PowerOFF.mp3" loop preload="auto"></audio>
        <audio id="audio-knock" src="https://raw.githubusercontent.com/Imagineoff/Imagineweb/main/Knock.mp3" preload="auto"></audio>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const $ = document.getElementById.bind(document);
            
            const DOM = {
                gameContainer: $('game-container'),
                screens: {
                    intro: $('intro-screen'),
                    room: $('room-screen'),
                    pc: $('pc-screen'),
                    gameOver: $('game-over-screen'),
                    win: $('win-screen')
                },
                studioLogo: $('studio-logo'),
                loadingBar: $('loading-bar-container'),
                introVideo: $('intro-video'), // PŘIDÁNO
                deviceSelect: $('device-select'),
                btnPC: $('btn-pc'),
                btnMobile: $('btn-mobile'),
                computerHotspot: $('computer-hotspot'),
                powerStripHotspot: $('power-strip-hotspot'), // PŘIDÁNO
                pillsContainer: $('pills-container'),
                pillCounter: $('pill-counter'),
                mobileBackBtn: $('mobile-back-btn'),
                tipsHUD: $('tips-hud'),
                pcDesktop: $('pc-desktop'),
                pcRebooting: $('pc-rebooting'),
                rebootBarFill: $('reboot-bar-fill'),
                taskCount: $('task-count'),
                pcTime: $('pc-time'),
                taskContainer: $('task-container'),
                pcPowerOff: $('pc-power-off'),
                pcSidebar: $('pc-sidebar'),
                panicOverlay: $('panic-overlay'),
                jumpscareVideo: $('jumpscare-video'),
                audioBreathing: $('audio-breathing'),
                audioPowerOn: $('audio-power-on'),
                audioPowerOff: $('audio-power-off'),
                audioKnock: $('audio-knock')
            };

            const Game = {
                device: 'pc',
                currentView: 'intro',
                pills: 5,
                tasksCompleted: 0,
                tasksTotal: 10,
                pcOn: true,
                pcRebooting: false,
                gameRunning: false,
                gameOver: false,
                currentPCView: 'tasks',
                timers: {},
                tips: [
                    "Take pills to stay calm.",
                    "The breathing is getting closer...",
                    "You can't stay here forever.",
                    "You must complete the tasks.",
                    "Turning off the PC helps... but wastes time.",
                    "She's still watching...",
                    "The room feels colder.",
                    "You can turn off the PC by clicking the power strip." // PŘIDÁNO
                ],
                
                start() {
                    this.gameRunning = true;
                    this.gameOver = false;
                    PanicManager.start();
                    UIManager.start();
                    AudioManager.startKnockTimer();
                    AudioManager.updateRoomState();
                },
                
                stop() {
                    this.gameRunning = false;
                    PanicManager.stop();
                    UIManager.stop();
                    PCManager.stopPCClock();
                    TaskManager.clearTask();
                    AudioManager.stopAll();
                    clearInterval(this.timers.knock);
                },
                
                win() {
                    if (this.gameOver) return;
                    this.gameOver = true;
                    this.stop();
                    switchScreen('win');
                    
                    setTimeout(() => {
                        AudioManager.triggerJumpscare();
                    }, 3000);
                },
                
                lose() {
                    if (this.gameOver) return;
                    this.gameOver = true;
                    this.stop();
                    switchScreen('gameOver');
                },
                
                restart() {
                    this.pills = 5;
                    this.tasksCompleted = 0;
                    this.pcOn = true;
                    this.pcRebooting = false;
                    this.currentPCView = 'tasks';
                    DOM.taskCount.textContent = this.tasksTotal;
                    DOM.pillCounter.textContent = this.pills;
                    
                    PanicManager.panic = 30;
                    PanicManager.highPanicActive = false;
                    PanicManager.extremePanicActive = false;
                    DOM.gameContainer.classList.remove('high-panic-blur', 'high-panic-shake', 'extreme-panic-filter');
                    DOM.panicOverlay.style.opacity = 0;
                    
                    TaskManager.currentTask = null;
                    
                    switchScreen('room');
                    this.start();
                }
            };

            const AudioManager = {
                breathingVolume: 1.0,
                
                init() {
                    DOM.audioBreathing.volume = 0;
                    DOM.audioPowerOn.volume = 0.15;
                    DOM.audioPowerOff.volume = 0.2;
                    DOM.audioKnock.volume = 0.7;
                },
                
                startBreathing() {
                    DOM.audioBreathing.play().catch(e => console.log('Audio play failed:', e));
                },
                
                stopBreathing() {
                    DOM.audioBreathing.pause();
                    DOM.audioBreathing.volume = 0;
                },
                
                setBreathingVolume(vol) {
                    this.breathingVolume = vol;
                    DOM.audioBreathing.volume = vol;
                },
                
                startPowerOnSound() {
                    DOM.audioPowerOn.play().catch(e => console.log('PowerOn audio failed:', e));
                },
                
                stopPowerOnSound() {
                    DOM.audioPowerOn.pause();
                    DOM.audioPowerOn.currentTime = 0;
                },
                
                startPowerOffSound() {
                    DOM.audioPowerOff.currentTime = 0;
                    DOM.audioPowerOff.play().catch(e => console.log('PowerOff audio failed:', e));
                },
                
                stopPowerOffSound() {
                    DOM.audioPowerOff.pause();
                    DOM.audioPowerOff.currentTime = 0;
                },
                
                updateRoomState() {
                    if (Game.pcOn) {
                        DOM.screens.room.classList.remove('pc-off-state');
                        DOM.screens.room.classList.add('pc-on-state');
                        this.startPowerOnSound();
                        this.stopPowerOffSound();
                    } else {
                        DOM.screens.room.classList.remove('pc-on-state');
                        DOM.screens.room.classList.add('pc-off-state');
                        this.stopPowerOnSound();
                        this.startPowerOffSound();
                    }
                },
                
                startKnockTimer() {
                    const playKnock = () => {
                        if (!Game.gameOver && Game.gameRunning) {
                            DOM.audioKnock.currentTime = 0;
                            DOM.audioKnock.play().catch(e => console.log('Knock audio failed:', e));
                        }
                        
                        const nextInterval = 60000 + Math.random() * 120000;
                        Game.timers.knock = setTimeout(playKnock, nextInterval);
                    };
                    
                    const firstInterval = 60000 + Math.random() * 120000;
                    Game.timers.knock = setTimeout(playKnock, firstInterval);
                },
                
                triggerJumpscare() {
                    DOM.jumpscareVideo.style.display = 'block';
                    DOM.jumpscareVideo.play().catch(e => {
                        console.log('Jumpscare video failed:', e);
                        DOM.jumpscareVideo.style.display = 'none';
                    });
                    
                    DOM.jumpscareVideo.addEventListener('ended', () => {
                        DOM.jumpscareVideo.style.display = 'none';
                    }, { once: true });
                },
                
                stopAll() {
                    this.stopBreathing();
                    this.stopPowerOnSound();
                    clearTimeout(Game.timers.knock);
                }
            };

            const PanicManager = {
                panic: 30,
                highPanicActive: false,
                extremePanicActive: false,
                
                start() {
                    Game.timers.panic = setInterval(this.update.bind(this), 1000);
                },
                
                stop() {
                    clearInterval(Game.timers.panic);
                },
                
                update() {
                    if (Game.gameOver) return;
                    
                    if (Game.pcOn) {
                        this.panic += 0.3;
                    } else {
                        this.panic = Math.max(0, this.panic - 0.5);
                    }
                    
                    this.panic = Math.min(100, this.panic);
                    this.checkState();
                },
                
                checkState() {
                    DOM.panicOverlay.style.opacity = Math.max(0, this.panic - 50) / 50 * 0.3;
                    
                    if (this.panic >= 75 && !this.highPanicActive) {
                        this.highPanicActive = true;
                        AudioManager.startBreathing();
                        DOM.gameContainer.classList.add('high-panic-blur', 'high-panic-shake');
                        DOM.panicOverlay.style.background = 'radial-gradient(circle, transparent 60%, rgba(255,0,0,0.3) 100%)';
                        UIManager.showTip("The breathing is getting closer...");
                    } else if (this.panic < 75 && this.highPanicActive) {
                        this.highPanicActive = false;
                        this.extremePanicActive = false;
                        AudioManager.stopBreathing();
                        DOM.gameContainer.classList.remove('high-panic-blur', 'high-panic-shake', 'extreme-panic-filter');
                        DOM.panicOverlay.style.background = 'radial-gradient(circle, transparent 70%, rgba(0,0,0,0) 80%, rgba(255,0,0,0.1) 95%)';
                    }

                    if (this.panic >= 85 && !this.extremePanicActive) {
                        this.extremePanicActive = true;
                        DOM.gameContainer.classList.add('extreme-panic-filter');
                    } else if (this.panic < 85 && this.extremePanicActive) {
                        this.extremePanicActive = false;
                        DOM.gameContainer.classList.remove('extreme-panic-filter');
                    }
                    
                    if(this.highPanicActive) {
                        DOM.panicOverlay.style.opacity = 0.4 + (this.panic - 75) / 25 * 0.6;
                        AudioManager.setBreathingVolume(0.8 + (this.panic - 75) / 25 * 0.2);
                    }

                    if (this.panic >= 100) {
                        Game.lose();
                    }
                },
                
                takePill() {
                    if (Game.pills > 0 && !Game.gameOver) {
                        Game.pills--;
                        DOM.pillCounter.textContent = Game.pills;
                        this.panic = Math.max(0, this.panic - 40);
                        
                        DOM.gameContainer.style.transition = 'transform 0.1s';
                        DOM.gameContainer.style.transform = 'scale(1.02)';
                        setTimeout(() => DOM.gameContainer.style.transform = 'scale(1)', 100);

                        this.checkState();
                        
                        if (Game.pills === 0) {
                            UIManager.showTip("You are out of pills... you're on your own.");
                        }
                    }
                }
            };
            
            const UIManager = {
                start() {
                    Game.timers.tip = setInterval(this.showRandomTip.bind(this), 35000);
                    setTimeout(() => this.showTip("Take pills to stay calm."), 5000);
                },
                
                stop() {
                    clearInterval(Game.timers.tip);
                },
                
                showTip(message) {
                    DOM.tipsHUD.textContent = message;
                    DOM.tipsHUD.style.opacity = 1;
                    setTimeout(() => {
                        DOM.tipsHUD.style.opacity = 0;
                    }, 5000);
                },

                showRandomTip() {
                    if (Game.gameOver) return;
                    const tip = Game.tips[Math.floor(Math.random() * Game.tips.length)];
                    this.showTip(tip);
                }
            };
            
            const PCManager = {
                pcClockTimer: null,
                
                init() {
                    DOM.computerHotspot.addEventListener('click', this.enterPCView.bind(this));
                    DOM.mobileBackBtn.addEventListener('click', this.leavePCView.bind(this));
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && Game.device === 'pc' && Game.currentView === 'pc') {
                            this.leavePCView();
                        }
                    });
                    
                    // ODEBRÁNO: Původní listener pro tlačítko
                    // DOM.pcPowerOff.addEventListener('click', this.turnOffPC.bind(this));
                    
                    // PŘIDÁNO: Nový listener pro prodlužovačku
                    DOM.powerStripHotspot.addEventListener('click', this.turnOffPC.bind(this));
                    
                    DOM.pcSidebar.addEventListener('click', (e) => {
                        if (e.target.classList.contains('pc-icon')) {
                            this.navigate(e.target.dataset.view);
                        }
                    });
                },
                
                navigate(view) {
                    DOM.pcSidebar.querySelectorAll('.pc-icon').forEach(icon => icon.classList.remove('active'));
                    DOM.pcSidebar.querySelector(`.pc-icon[data-view="${view}"]`).classList.add('active');
                    Game.currentPCView = view;
                    
                    if (view === 'tasks') {
                        TaskManager.loadCurrentTask();
                    } else if (view === 'logs') {
                        this.showLogs();
                    }
                },
                
                showLogs() {
                    TaskManager.clearTask();
                    DOM.taskContainer.innerHTML = `
                        <p class="task-description">PERSONAL LOGS</p>
                        <p><strong>Entry 01:</strong> My head... hurts. Where am I? This room... I don't recognize it. Need to focus. The terminal. Maybe it has answers.</p>
                        <br>
                        <p><strong>Entry 02:</strong> I keep hearing things. A... a creak. A whisper. Just my mind playing tricks. The pills help. For now.</p>
                        <br>
                        <p><strong>Entry 03:</strong> It's her. It's... it can't be. She's gone. I know she is. So why do I hear her breathing? Why won't she leave me alone?</p>
                        <br>
                        <p><strong>Entry 04:</strong> The tasks. They're like... memories. Fragments. I have to do them. I have to... what? Remember? Or forget?</p>
                        <br>
                        <p><strong>Entry 05:</strong> It wasn't my fault. It was an accident. It was... I... no... no... she... she fell. That's what happened. She fell.</p>
                        <br>
                        <p><strong>Entry 06:</strong> ...he will never forget... he will never forget... HE WILL NEVER FORGET</p>
                    `;
                },

                enterPCView() {
                    if (Game.currentView === 'pc' || Game.gameOver) return;

                    Game.currentView = 'pc';
                    DOM.screens.room.style.transform = "scale(3.5) translate(-15%, -25%)"; 
                    DOM.screens.room.style.opacity = 0.5;
                    DOM.screens.pc.classList.add('active');
                    
                    if (Game.pcRebooting) return;

                    if (!Game.pcOn) {
                        DOM.pcDesktop.style.display = 'none';
                        DOM.pcRebooting.style.display = 'block';
                        this.runRebootSequence();
                    } else {
                        DOM.pcDesktop.style.display = 'flex';
                        DOM.pcRebooting.style.display = 'none';
                        this.navigate(Game.currentPCView);
                        this.startPCClock();
                    }
                },

                leavePCView() {
                    if (Game.currentView !== 'pc' || Game.gameOver) return;
                    
                    Game.currentView = 'room';
                    DOM.screens.room.style.transform = "scale(1) translate(0, 0)";
                    DOM.screens.room.style.opacity = 1;
                    DOM.screens.pc.classList.remove('active');
                    this.stopPCClock();
                    TaskManager.clearTask();
                },

                // Tato funkce se nyní volá kliknutím na prodlužovačku
                turnOffPC() {
                    if (!Game.pcOn) return; // Dělá nic, pokud je PC již vypnuté
                    Game.pcOn = false;
                    TaskManager.clearTask();
                    TaskManager.currentTask = null;
                    this.leavePCView();
                    AudioManager.updateRoomState();
                    UIManager.showTip("PC shutting down. Things feel... quieter.");
                },

                runRebootSequence() {
                    if (Game.pcRebooting) return;
                    Game.pcRebooting = true;
                    
                    const rebootDuration = 15000;
                    DOM.rebootBarFill.style.transition = `width ${rebootDuration}ms linear`;
                    DOM.rebootBarFill.style.width = '100%';

                    setTimeout(() => {
                        Game.pcOn = true;
                        Game.pcRebooting = false;
                        DOM.rebootBarFill.style.transition = 'none';
                        DOM.rebootBarFill.style.width = '0%';
                        AudioManager.updateRoomState();

                        if (Game.currentView === 'pc') {
                            DOM.pcDesktop.style.display = 'flex';
                            DOM.pcRebooting.style.display = 'none';
                            this.navigate('tasks');
                            this.startPCClock();
                        }
                    }, rebootDuration);
                },

                startPCClock() {
                    let time = 0;
                    if (this.pcClockTimer) clearInterval(this.pcClockTimer);
                    this.pcClockTimer = setInterval(() => {
                        time++;
                        const minutes = String(Math.floor(time / 60)).padStart(2, '0');
                        const seconds = String(time % 60).padStart(2, '0');
                        DOM.pcTime.textContent = `${minutes}:${seconds}`;
                    }, 1000);
                },

                stopPCClock() {
                    if (this.pcClockTimer) clearInterval(this.pcClockTimer);
                    this.pcClockTimer = null;
                }
            };
            
            const TaskManager = {
                currentTask: null,
                currentTaskCleanup: null,
                
                tasks: [
                    { name: "Type Code", init: "task_typeCode" },
                    { name: "Reaction Test", init: "task_clickReaction" },
                    { name: "Stabilize", init: "task_stabilize" },
                    { name: "Pac-Man", init: "task_pacman" }
                ],
                
                loadCurrentTask() {
                    if (Game.currentPCView !== 'tasks') return;
                    
                    if (this.currentTask) {
                        const initFunc = this.taskImplementations[this.currentTask.init];
                        if(initFunc) {
                            initFunc.call(this.taskImplementations);
                        } else {
                            this.loadNextTask();
                        }
                    } else {
                        this.loadNextTask();
                    }
                },
                
                loadNextTask: function() {
                    if (Game.tasksCompleted >= Game.tasksTotal) {
                        Game.win();
                        return;
                    }

                    this.clearTask();
                    DOM.taskContainer.innerHTML = '<h3>Loading new task...</h3>';
                    
                    setTimeout(() => {
                        if (Game.currentPCView !== 'tasks') return;
                        
                        const taskIndex = Game.tasksCompleted % this.tasks.length;
                        this.currentTask = this.tasks[taskIndex];
                        
                        const initFunc = this.taskImplementations[this.currentTask.init];
                        if(initFunc) {
                            initFunc.call(this.taskImplementations);
                        } else {
                            console.error("Task init function not found:", this.currentTask.init);
                        }
                    }, 1000 + Math.random() * 1500);
                },
                
                clearTask() {
                    if (this.currentTaskCleanup) {
                        this.currentTaskCleanup();
                        this.currentTaskCleanup = null;
                    }
                    DOM.taskContainer.innerHTML = '';
                },

                completeTask: function() {
                    if (Game.gameOver) return;
                    this.clearTask();
                    
                    Game.tasksCompleted++;
                    this.currentTask = null;
                    DOM.taskCount.textContent = Game.tasksTotal - Game.tasksCompleted;
                    DOM.taskContainer.innerHTML = `<h2 style="color: #0f0;">TASK COMPLETE.</h2><p>Calibrating next module...</p>`;
                    
                    PanicManager.panic = Math.max(0, PanicManager.panic - 5);
                    
                    setTimeout(() => {
                        if(Game.currentPCView === 'tasks' && !Game.gameOver) {
                            this.loadNextTask();
                        }
                    }, 2000);
                },

                taskImplementations: {
                    task_typeCode() {
                        const code = Array(15).fill(0).map(() => "abcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(Math.random() * 36))).join('');
                        DOM.taskContainer.innerHTML = `
                            <p class="task-description">SECURITY PROTOCOL: Type the following verification code exactly:</p>
                            <h3 id="task-type-code">${code}</h3>
                            <input type="text" id="task-type-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                        `;
                        
                        const input = $('task-type-input');
                        input.focus();

                        const keyHandler = (e) => {
                            if (e.target.value === code) {
                                TaskManager.completeTask();
                            } else if (code.startsWith(e.target.value)) {
                                input.style.borderColor = '#444';
                            } else {
                                input.style.borderColor = 'red';
                            }
                        };
                        input.addEventListener('keyup', keyHandler);
                        
                        TaskManager.currentTaskCleanup = () => {
                            input.removeEventListener('keyup', keyHandler);
                        };
                    },

                    task_clickReaction() {
                        DOM.taskContainer.innerHTML = `
                            <p class="task-description">REFLEX CALIBRATION: Click the <strong>green</strong> square as fast as possible.</p>
                            <div id="task-reaction-grid">
                                ${Array(9).fill(0).map(() => `<div class="reaction-square"></div>`).join('')}
                            </div>
                        `;

                        const squares = DOM.taskContainer.querySelectorAll('.reaction-square');
                        const timeoutId = setTimeout(() => {
                            const targetIndex = Math.floor(Math.random() * squares.length);
                            squares[targetIndex].classList.add('target');
                            
                            const clickHandler = () => TaskManager.completeTask();
                            squares[targetIndex].addEventListener('click', clickHandler, { once: true });
                            squares[targetIndex].addEventListener('touchend', (e) => {
                                e.preventDefault();
                                clickHandler();
                            }, { once: true });
                        }, 1500 + Math.random() * 3000);

                        TaskManager.currentTaskCleanup = () => {
                            clearTimeout(timeoutId);
                            squares.forEach(sq => sq.replaceWith(sq.cloneNode(true)));
                        };
                    },
                    
                    task_pacman() {
                        DOM.taskContainer.innerHTML = `
                            <p class="task-description">DATA FRAGMENT RECOVERY: Collect all dots (<strong>.</strong>). Avoid the <strong>G</strong>host.</p>
                            <div id="task-pacman-grid"></div>
                            <p>Use <strong>Arrow Keys</strong> or <strong>W,A,S,D</strong> to move. On mobile, swipe to move.</p>
                        `;
                        
                        const gridEl = $('task-pacman-grid');
                        const grid = [
                            "##########",
                            "#P.......#",
                            "#.###..G.#",
                            "#...#....#",
                            "##########",
                        ];
                        let player = {x: 1, y: 1};
                        let ghost = {x: 7, y: 2};
                        let dots = 12;

                        function drawGrid() {
                            gridEl.innerHTML = grid.map((row, y) => {
                                return row.split('').map((cell, x) => {
                                    if (x === player.x && y === player.y) return '<span class="pac-player">P</span>';
                                    if (x === ghost.x && y === ghost.y) return '<span class="pac-ghost">G</span>';
                                    if (cell === '.') return '<span class="pac-dot">.</span>';
                                    if (cell === '#') return '<span class="pac-wall">#</span>';
                                    return ' ';
                                }).join('');
                            }).join('\n');
                        }
                        
                        function move(dx, dy) {
                            const newX = player.x + dx;
                            const newY = player.y + dy;
                            
                            if (grid[newY][newX] === '#') return;
                            
                            player.x = newX;
                            player.y = newY;
                            
                            if (grid[newY][newX] === '.') {
                                dots--;
                                grid[newY] = grid[newY].substring(0, newX) + ' ' + grid[newY].substring(newX + 1);
                                if (dots === 0) TaskManager.completeTask();
                            }
                            
                            if (player.x === ghost.x && player.y === ghost.y) {
                                TaskManager.loadCurrentTask();
                            }
                            
                            moveGhost();
                            drawGrid();
                        }
                        
                        function moveGhost() {
                            const dx = Math.sign(player.x - ghost.x);
                            const dy = Math.sign(player.y - ghost.y);
                            
                            const moveDir = Math.random() > 0.5 ? 'x' : 'y';
                            if (moveDir === 'x' && grid[ghost.y][ghost.x + dx] !== '#') ghost.x += dx;
                            else if (moveDir === 'y' && grid[ghost.y + dy][ghost.x] !== '#') ghost.y += dy;
                            else if (grid[ghost.y][ghost.x + dx] !== '#') ghost.x += dx;
                            else if (grid[ghost.y + dy][ghost.x] !== '#') ghost.y += dy;
                            
                            if (player.x === ghost.x && player.y === ghost.y) {
                                TaskManager.loadCurrentTask();
                            }
                        }
                        
                        const keyHandler = (e) => {
                            e.preventDefault();
                            switch(e.key) {
                                case 'ArrowUp': case 'w': case 'W': move(0, -1); break;
                                case 'ArrowDown': case 's': case 'S': move(0, 1); break;
                                case 'ArrowLeft': case 'a': case 'A': move(-1, 0); break;
                                case 'ArrowRight': case 'd': case 'D': move(1, 0); break;
                            }
                        };
                        
                        let touchStartX = 0;
                        let touchStartY = 0;
                        const touchStart = (e) => {
                            touchStartX = e.touches[0].clientX;
                            touchStartY = e.touches[0].clientY;
                        };
                        const touchEnd = (e) => {
                            const touchEndX = e.changedTouches[0].clientX;
                            const touchEndY = e.changedTouches[0].clientY;
                            const dx = touchEndX - touchStartX;
                            const dy = touchEndY - touchStartY;
                            
                            if (Math.abs(dx) > Math.abs(dy)) {
                                if (dx > 20) move(1, 0);
                                else if (dx < -20) move(-1, 0);
                            } else {
                                if (dy > 20) move(0, 1);
                                else if (dy < -20) move(0, -1);
                            }
                        };
                        
                        document.addEventListener('keydown', keyHandler);
                        gridEl.addEventListener('touchstart', touchStart);
                        gridEl.addEventListener('touchend', touchEnd);
                        
                        TaskManager.currentTaskCleanup = () => {
                            document.removeEventListener('keydown', keyHandler);
                            gridEl.removeEventListener('touchstart', touchStart);
                            gridEl.removeEventListener('touchend', touchEnd);
                        };
                        drawGrid();
                    },
                    
                    task_stabilize() {
                        DOM.taskContainer.innerHTML = `
                            <p class="task-description">CORE OSCILLATOR: Keep the <strong>yellow bar</strong> inside the <strong>green target zone</strong> for <strong>5</strong> seconds.</p>
                            <div id="task-stabilize-container">
                                <div id="task-stabilize-target"></div>
                                <div id="task-stabilize-bar"></div>
                            </div>
                            <p>Press <strong>Spacebar</strong> or <strong>Tap Screen</strong> to apply counter-thrust.</p>
                        `;
                        
                        const bar = $('task-stabilize-bar');
                        const container = $('task-stabilize-container');
                        let pos = 50;
                        let velocity = 0;
                        let gravity = 0.08;
                        let thrust = -0.3;
                        let timeInZone = 0;
                        const targetTime = 5000;
                        
                        function applyThrust() {
                            velocity += thrust;
                        }
                        
                        const keyHandler = (e) => {
                            if (e.code === 'Space') {
                                e.preventDefault();
                                applyThrust();
                            }
                        };
                        
                        const touchHandler = (e) => {
                            e.preventDefault();
                            applyThrust();
                        };
                        
                        let interval = setInterval(() => {
                            velocity += gravity;
                            pos += velocity;
                            
                            if (pos < 0) { pos = 0; velocity *= -0.4; }
                            if (pos > 100) { pos = 100; velocity *= -0.4; }
                            
                            bar.style.left = `${pos}%`;
                            
                            if (pos > 42.5 && pos < 57.5) {
                                timeInZone += 20;
                                DOM.taskContainer.querySelector('.task-description').innerHTML = `CORE OSCILLATOR: ... ${((timeInZone / targetTime) * 100).toFixed(0)}%`;
                                if (timeInZone >= targetTime) {
                                    TaskManager.completeTask();
                                }
                            } else {
                                timeInZone = 0;
                            }
                        }, 20);
                        
                        document.addEventListener('keydown', keyHandler);
                        container.addEventListener('touchstart', touchHandler);
                        container.addEventListener('click', applyThrust);
                        
                        TaskManager.currentTaskCleanup = () => {
                            clearInterval(interval);
                            document.removeEventListener('keydown', keyHandler);
                            container.removeEventListener('touchstart', touchHandler);
                            container.removeEventListener('click', applyThrust);
                        };
                    }
                }
            };

            function switchScreen(screenName) {
                Object.values(DOM.screens).forEach(s => s.classList.remove('active'));
                DOM.screens[screenName].classList.add('active');
            }

            // --- UPRAVENO: Přidána logika pro přehrání videa ---
            function initDeviceSelection() {
                const showDeviceSelect = () => {
                    DOM.introVideo.style.display = 'none'; // Skryj video
                    DOM.deviceSelect.style.opacity = 1;
                    DOM.deviceSelect.style.display = 'block';
                };

                setTimeout(() => {
                    // Skryj logo a loading bar
                    DOM.studioLogo.style.display = 'none';
                    DOM.loadingBar.style.display = 'none';
                    
                    // Ukaž a přehraj video
                    DOM.introVideo.style.display = 'block';
                    DOM.introVideo.play().then(() => {
                        // Video se přehrává
                    }).catch(e => {
                        // Autoplay selhal, přeskoč rovnou na výběr
                        console.log('Intro video autoplay failed:', e);
                        showDeviceSelect();
                    });

                    // Po skončení videa ukaž výběr zařízení
                    DOM.introVideo.addEventListener('ended', showDeviceSelect, { once: true });

                }, 5500); // Původní časování, kdy se má ukázat výběr
                
                DOM.btnPC.addEventListener('click', () => {
                    Game.device = 'pc';
                    startGame();
                });
                
                DOM.btnMobile.addEventListener('click', () => {
                    Game.device = 'mobile';
                    DOM.mobileBackBtn.style.display = 'block';
                    startGame();
                });
            }
            // --- KONEC ÚPRAVY ---

            function startGame() {
                switchScreen('room');
                Game.start();
            }

            DOM.pillsContainer.addEventListener('click', () => {
                if (Game.pills > 0 && !Game.gameOver) {
                    PanicManager.takePill();
                }
            });

            DOM.pillsContainer.addEventListener('touchend', (e) => {
                e.preventDefault();
                if (Game.pills > 0 && !Game.gameOver) {
                    PanicManager.takePill();
                }
            });

            $('restart-btn').addEventListener('click', () => Game.restart());
            $('restart-btn-win').addEventListener('click', () => Game.restart());

            AudioManager.init();
            PCManager.init();
            initDeviceSelection();
        });
    </script>
</body>
</html>
