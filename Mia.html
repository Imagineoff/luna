<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Imagineoff/luna/main/Mia.png">
    <title>Mia</title>
    
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <style>
        * { box-sizing: border-box; }
        body { 
            background-color: #000; 
            color: #fff; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, sans-serif; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100dvh; 
            overflow: hidden; 
        }

        #auth-overlay {
            position: fixed;
            top: 0; left: 0; 
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }

        .auth-text {
            margin-bottom: 20px;
            font-size: 14px;
            letter-spacing: 2px;
            color: #888;
            text-transform: uppercase;
        }

        #viz-container { 
            flex: 0 0 150px;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative;
            background: radial-gradient(circle at center, #111 0%, #000 70%);
        }

        canvas { width: 100%; height: 100%; display: block; }

        #chat-container { 
            flex: 1; overflow-y: auto; padding: 20px; 
            display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; 
            position: relative;
        }

        .msg { 
            max-width: 85%; padding: 10px 15px; line-height: 1.6; font-size: 1.1rem;
            border-radius: 8px;
            transition: all 1s ease;
        }
        
        .user { 
            align-self: flex-end; 
            color: #fff; 
            text-align: right;
            border-right: 2px solid #333;
        }
        
        .bot { 
            align-self: flex-start; 
            color: #ccc; 
            border-left: 2px solid #333;
        } 

        .msg.blur-out {
            filter: blur(8px);
            opacity: 0;
            transform: scale(0.98);
        }

        #controls { 
            padding: 10px 20px; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            gap: 20px;
            background: #050505;
            border-top: 1px solid #111;
        }

        .control-group {
            display: flex; gap: 10px;
        }

        .control-btn {
            font-size: 11px; letter-spacing: 1px; background: #111; border: 1px solid #222;
            color: #666; cursor: pointer; transition: all 0.2s; text-transform: uppercase;
            padding: 8px 12px; border-radius: 4px;
        }
        .control-btn:hover { color: #fff; border-color: #444; }
        .control-btn.active { color: #fff; border-color: #fff; }

        #input-container { 
            padding: 20px; display: flex; gap: 10px; align-items: center; 
            background: #000;
        }
        
        input { 
            flex: 1; background: transparent; border: none; color: #fff; 
            padding: 15px 10px; outline: none; font-size: 16px; border-bottom: 1px solid #222;
            transition: border-color 0.3s;
        }
        input:focus { border-bottom-color: #555; }

        button#sendBtn { 
            background: #fff; color: #000; border: none; cursor: pointer; 
            font-weight: bold; font-size: 12px; letter-spacing: 1px; 
            padding: 10px 20px; border-radius: 20px;
            transition: opacity 0.3s;
        }
        button#sendBtn:disabled { opacity: 0.2; cursor: not-allowed; }
        
        #youtube-player { position: absolute; top: -9999px; visibility: hidden; }
    </style>
</head>
<body>

<div id="auth-overlay">
    <div class="auth-text">System Verification</div>
    <div class="cf-turnstile" 
         data-sitekey="0x4AAAAAACY_ilRmHF1IfQfP" 
         data-callback="onTurnstileSuccess" 
         data-theme="dark">
    </div>
</div>

<div id="viz-container">
    <canvas id="canvas"></canvas>
</div>

<div id="chat-container"></div>

<div id="controls">
    <div class="control-group">
        <button id="stopMusicBtn" class="control-btn" style="display:none;">STOP MUSIC</button>
        <button id="pauseMusicBtn" class="control-btn" style="display:none;">PAUSE</button>
    </div>
    <div class="control-group">
        <button id="stopVoiceBtn" class="control-btn">SILENCE</button>
        <button id="clearMemBtn" class="control-btn">RESET MEMORY</button>
    </div>
</div>

<div id="input-container">
    <input type="text" id="userInput" placeholder="Initializing..." autocomplete="off" disabled>
    <button id="sendBtn" disabled>SEND</button>
</div>

<div id="youtube-player"></div>

<script>
    let turnstileToken = null;
    let conversationHistory = [];
    let isMusicPlaying = false;
    let isSpeaking = false;
    let animationId;
    let player; 
    let synth = window.speechSynthesis;
    let visualizerCtx;
    let dataArray;
    let analyser;
    
    // Load memory
    try {
        const saved = localStorage.getItem('mia_history');
        if (saved) conversationHistory = JSON.parse(saved);
    } catch(e) { console.log('Memory error'); }

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const chatContainer = document.getElementById('chat-container');
    
    // Controls
    const stopMusicBtn = document.getElementById('stopMusicBtn');
    const pauseMusicBtn = document.getElementById('pauseMusicBtn');
    const stopVoiceBtn = document.getElementById('stopVoiceBtn');
    const clearMemBtn = document.getElementById('clearMemBtn');

    window.onTurnstileSuccess = function(token) {
        turnstileToken = token;
        const overlay = document.getElementById('auth-overlay');
        overlay.style.opacity = '0'; 
        setTimeout(() => {
            overlay.style.display = 'none'; 
            userInput.disabled = false;
            userInput.placeholder = "Type to Mia...";
            userInput.focus();
            if (userInput.value.trim().length > 0) sendBtn.disabled = false;
        }, 500);
    };

    function resetTurnstile() {
        if (window.turnstile) {
            turnstile.reset();
            // We do not show overlay immediately, we wait for next send attempt logic
        }
    }

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('youtube-player', {
            height: '0', width: '0',
            playerVars: {
                'autoplay': 1,
                'controls': 0,
                'disablekb': 1,
                'fs': 0
            },
            events: { 
                'onStateChange': onPlayerStateChange,
                'onError': onPlayerError
            }
        });
    }

    function onPlayerStateChange(event) {
        if (event.data === YT.PlayerState.PLAYING) {
            isMusicPlaying = true;
            stopMusicBtn.style.display = 'block';
            pauseMusicBtn.style.display = 'block';
            pauseMusicBtn.innerText = "PAUSE";
            if (!animationId) draw();
        } else if (event.data === YT.PlayerState.PAUSED) {
            pauseMusicBtn.innerText = "RESUME";
        } else if (event.data === YT.PlayerState.ENDED) {
            isMusicPlaying = false;
            stopMusicBtn.style.display = 'none';
            pauseMusicBtn.style.display = 'none';
        }
    }

    function onPlayerError(e) { console.error("YT Error:", e); }

    stopMusicBtn.onclick = () => {
        if (player) player.stopVideo();
        isMusicPlaying = false;
        stopMusicBtn.style.display = 'none';
        pauseMusicBtn.style.display = 'none';
    };

    pauseMusicBtn.onclick = () => {
        if (!player) return;
        if (player.getPlayerState() === YT.PlayerState.PLAYING) player.pauseVideo();
        else player.playVideo();
    };

    stopVoiceBtn.onclick = () => {
        synth.cancel();
        isSpeaking = false;
    };

    clearMemBtn.onclick = () => {
        localStorage.removeItem('mia_history');
        conversationHistory = [];
        location.reload();
    };

    function playMusic(query) {
        if (!player) return;
        // Search and play first result
        player.loadPlaylist({
            listType: 'search',
            list: query,
            index: 0
        });
    }

    function speak(text) {
        synth.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        
        let voices = synth.getVoices();
        let selectedVoice = voices.find(v => v.name.includes('Google US English')) || 
                           voices.find(v => v.lang.includes('en-US')) || 
                           voices[0];
        
        if (selectedVoice) utterance.voice = selectedVoice;
        utterance.rate = 1.0;
        utterance.pitch = 1.0;

        utterance.onstart = () => {
            isSpeaking = true;
            sendBtn.disabled = true; // Block input while speaking
            userInput.disabled = true;
            userInput.placeholder = "Mia is speaking...";
            
            // Fade out text bubbles
            const bubbles = document.querySelectorAll('.msg.bot');
            bubbles.forEach(b => b.classList.add('blur-out'));
            
            if (!animationId) draw();
        };

        utterance.onend = () => {
            isSpeaking = false;
            sendBtn.disabled = false;
            userInput.disabled = false;
            userInput.placeholder = "Type to Mia...";
            userInput.focus();
            
            if (!isMusicPlaying) {
                cancelAnimationFrame(animationId);
                animationId = null;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        };
        
        synth.speak(utterance);
    }

    function draw() {
        animationId = requestAnimationFrame(draw);
        const w = canvas.width;
        const h = canvas.height;
        ctx.clearRect(0, 0, w, h);
        
        const bars = 50;
        const barWidth = w / bars;
        const time = Date.now() * 0.003;

        for (let i = 0; i < bars; i++) {
            let height = 5;
            let r, g, b;

            // Logic: Voice = White, Music = Colored Pulse
            if (isSpeaking && !isMusicPlaying) {
                height = Math.random() * (h * 0.6) + 5;
                ctx.fillStyle = "#ffffff";
            } else if (isMusicPlaying) {
                // Music visualizer simulation (sine waves)
                const offset = i * 0.2;
                const wave = Math.sin(time + offset) * (h * 0.3) + (h * 0.2);
                height = isSpeaking ? wave + (Math.random() * 20) : wave;
                
                // Color cycle
                const hue = (time * 20 + i * 5) % 360;
                ctx.fillStyle = `hsl(${hue}, 70%, 60%)`;
            } else {
                ctx.fillStyle = "#222"; 
            }

            const x = i * barWidth;
            const y = (h - height) / 2;
            
            // Draw rounded pill shape
            ctx.beginPath();
            ctx.roundRect(x + 2, y, barWidth - 4, height, 4);
            ctx.fill();
        }
    }

    async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;
        
        // Check verification
        if (!turnstileToken) {
            alert("Please complete security check.");
            document.getElementById('auth-overlay').style.display = 'flex';
            document.getElementById('auth-overlay').style.opacity = '1';
            return;
        }

        appendMessage('user', text);
        conversationHistory.push({ role: "user", content: text });
        localStorage.setItem('mia_history', JSON.stringify(conversationHistory));
        
        userInput.value = '';
        sendBtn.disabled = true;

        if (isMusicPlaying) player.setVolume(15); 

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    history: conversationHistory,
                    turnstileToken: turnstileToken
                })
            });
            
            const data = await response.json();
            
            // Refresh token immediately after use for next message
            resetTurnstile(); 
            turnstileToken = null; // Force user to re-verify or wait for auto-verify if needed, 
            // but usually we want silent reset. Since user asked for "checkbox again" on spam, 
            // setting token to null ensures next click requires a valid token.
            
            if (data.error) {
                // If token invalid, show overlay
                document.getElementById('auth-overlay').style.display = 'flex';
                document.getElementById('auth-overlay').style.opacity = '1';
                throw new Error(data.error);
            }

            appendMessage('bot', data.text);
            conversationHistory.push({ role: "assistant", content: data.text });
            localStorage.setItem('mia_history', JSON.stringify(conversationHistory));

            speak(data.text);
            
            if (data.musicQuery) {
                playMusic(data.musicQuery);
            }
            
            // Restore volume after delay handled by speak() end
            setTimeout(() => {
                if (isMusicPlaying && !isSpeaking) player.setVolume(100);
            }, 1000);

        } catch (err) {
            console.error(err);
            appendMessage('bot', 'Connection interrupted. Verification required.');
            if (isMusicPlaying) player.setVolume(100);
            sendBtn.disabled = false;
        }
    }

    function appendMessage(role, text) {
        const div = document.createElement('div');
        div.className = `msg ${role}`;
        div.innerText = text;
        chatContainer.appendChild(div);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    userInput.oninput = () => {
        sendBtn.disabled = userInput.value.trim().length === 0;
    }
    
    sendBtn.onclick = sendMessage;
    userInput.onkeypress = (e) => { 
        if (e.key === 'Enter' && !sendBtn.disabled) sendMessage(); 
    };

    window.onresize = () => {
        canvas.width = document.getElementById('viz-container').clientWidth;
        canvas.height = document.getElementById('viz-container').clientHeight;
    };
    window.onresize();
</script>
</body>
</html>
