<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mia AI</title>
    <style>
        /* Reset a z치kladn칤 layout pro mobile-first */
        * { box-sizing: border-box; }
        body { 
            background-color: #050505; 
            color: #e0e0e0; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100dvh; /* Dynamic viewport height pro mobily */
            overflow: hidden; 
        }

        /* Sekce vizu치lu (Logo + Typewriter + Vizualiz칠r) */
        #viz-container { 
            flex: 0 0 auto;
            padding: 20px 0 10px 0;
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center; 
            border-bottom: 1px solid #222; 
            background: linear-gradient(180deg, #0a0a0a 0%, #000 100%);
        }

        /* Avatar */
        .avatar-img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px solid #fff;
            object-fit: cover;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
            margin-bottom: 10px;
        }

        /* Typewriter text */
        #typewriter {
            font-size: 0.9rem;
            color: #888;
            font-weight: 400;
            height: 1.2em; /* Fixn칤 v칳코ka aby to nesk치kalo */
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }
        
        /* Blikaj칤c칤 kurzor */
        .cursor {
            display: inline-block;
            width: 2px;
            background-color: #fff;
            animation: blink 1s infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* Canvas pro vizualizaci */
        canvas { 
            width: 100%; 
            height: 60px; /* Men코칤 v칳코ka pro 캜ist코칤 vzhled */
            display: block;
        }

        /* Chat oblast */
        #chat-container { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            scroll-behavior: smooth; 
            background: #000;
        }

        /* Bubliny zpr치v */
        .msg { 
            max-width: 85%; 
            padding: 12px 16px; 
            border-radius: 18px; 
            line-height: 1.5; 
            font-size: 0.95rem;
            position: relative;
            word-wrap: break-word;
        }
        .user { 
            align-self: flex-end; 
            background: #fff; 
            color: #000; 
            border-bottom-right-radius: 4px;
        }
        .bot { 
            align-self: flex-start; 
            background: #1a1a1a; 
            color: #fff; 
            border: 1px solid #333;
            border-bottom-left-radius: 4px;
        }

        /* Input oblast */
        #input-container { 
            flex: 0 0 auto;
            padding: 15px; 
            border-top: 1px solid #222; 
            display: flex; 
            gap: 10px; 
            background: #050505;
        }
        
        input { 
            flex: 1; 
            background: #111; 
            border: 1px solid #333; 
            color: #fff; 
            padding: 12px 15px; 
            border-radius: 25px;
            outline: none; 
            font-size: 16px; /* Prevence zoomu na iOS */
            transition: border 0.3s, background 0.3s; 
        }
        input:focus { 
            border-color: #666; 
            background: #1a1a1a;
        }
        
        button { 
            background: #fff; 
            color: #000; 
            border: none; 
            padding: 0 20px; 
            border-radius: 25px;
            cursor: pointer; 
            font-weight: 700; 
            font-size: 0.9rem;
            transition: opacity 0.2s;
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Skryt칤 scrollbaru ale zachov치n칤 funk캜nosti */
        #chat-container::-webkit-scrollbar { width: 6px; }
        #chat-container::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    </style>
</head>
<body>

<div id="viz-container">
    <img src="https://raw.githubusercontent.com/Imagineoff/luna/main/Mia.png" alt="Mia AI" class="avatar-img">
    
    <div id="typewriter"><span id="type-text"></span><span class="cursor">&nbsp;</span></div>
    
    <canvas id="canvas"></canvas>
</div>

<div id="chat-container">
    <div class="msg bot">Ahoj, j치 jsem Mia. Co m치코 na srdci? 游둯</div>
</div>

<div id="input-container">
    <input type="text" id="userInput" placeholder="Napi코 zpr치vu..." autocomplete="off">
    <button id="sendBtn">ODESLAT</button>
</div>

<script>
    // --- TYPEWRITER EFFECT ---
    const textToType = "Mia - inteligentn칤 par콘치k - free personal AI agent";
    const typeSpeed = 50; // ms per char
    let charIndex = 0;

    function typeWriter() {
        if (charIndex < textToType.length) {
            document.getElementById("type-text").textContent += textToType.charAt(charIndex);
            charIndex++;
            setTimeout(typeWriter, typeSpeed);
        } else {
            // Voliteln캩: zastavit blik치n칤 kurzoru po dops치n칤
            document.querySelector('.cursor').style.animation = 'none';
            document.querySelector('.cursor').style.opacity = '0';
        }
    }
    // Spustit psan칤 po na캜ten칤
    window.onload = typeWriter;

    // --- AUDIO & CHAT LOGIC ---
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const chatContainer = document.getElementById('chat-container');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');

    // Resize canvas pro lep코칤 ostrost
    function resizeCanvas() {
        canvas.width = canvas.parentElement.offsetWidth;
        canvas.height = 100; // Intern칤 rozli코en칤
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    let audioCtx, analyser, dataArray, source;
    let animationId;

    function initAudio(buffer) {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        // Zastavit p콏edchoz칤 zvuk pokud hraje
        if (source) { try { source.stop(); } catch(e){} }
        
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256;
        analyser.smoothingTimeConstant = 0.7; // Plynulej코칤 pohyb
        
        audioCtx.decodeAudioData(buffer, (decodedData) => {
            source = audioCtx.createBufferSource();
            source.buffer = decodedData;
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
            
            const bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);
            
            source.start(0);
            draw();
        });
    }

    function draw() {
        if (!analyser) return;
        animationId = requestAnimationFrame(draw);
        analyser.getByteFrequencyData(dataArray);
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        const barCount = 40; // Zobraz칤me jen spodn칤 frekvence pro hez캜칤 efekt
        const barWidth = canvas.width / barCount;
        
        // Gradient pro sloupce
        let gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, '#ffffff');
        gradient.addColorStop(1, '#555555');
        ctx.fillStyle = gradient;

        for (let i = 0; i < barCount; i++) {
            // Zobrazujeme trochu 코ir코칤 spektrum
            let value = dataArray[i + 5] || 0; 
            let percent = value / 255;
            let height = canvas.height * percent * 0.8; // Max v칳코ka 80%
            
            // Centrov치n칤 sloupc콢 vertik치ln캩
            let y = (canvas.height - height) / 2;
            
            // Zaoblen칠 sloupce (jednoduch칠)
            ctx.fillRect(i * barWidth + 1, y, barWidth - 2, height);
        }
    }

    async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        appendMessage('user', text);
        userInput.value = '';
        sendBtn.disabled = true;
        sendBtn.innerText = '...';

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text })
            });

            const data = await response.json();
            
            if (data.error) throw new Error(data.error);

            appendMessage('bot', data.text);

            if (data.audioBase64) {
                const audioBytes = Uint8Array.from(atob(data.audioBase64), c => c.charCodeAt(0));
                initAudio(audioBytes.buffer);
            }
        } catch (err) {
            console.error(err);
            appendMessage('bot', 'Promi켿, n캩co se pokazilo. Zkus to znovu.');
        } finally {
            sendBtn.disabled = false;
            sendBtn.innerText = 'ODESLAT';
            userInput.focus();
        }
    }

    function appendMessage(role, text) {
        const div = document.createElement('div');
        div.className = `msg ${role}`;
        div.innerText = text;
        chatContainer.appendChild(div);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    sendBtn.onclick = sendMessage;
    userInput.onkeypress = (e) => { if (e.key === 'Enter') sendMessage(); };
</script>

</body>
</html>
